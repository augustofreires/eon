#!/usr/bin/expect -f

set timeout 30

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "🔍 VERIFICANDO QUAL BANCO O SERVIDOR ESTÁ USANDO..."

# Verificar arquivo principal de conexão
send "find server/ -name '*.js' -exec grep -l 'database\\|Database\\|DB' {} \\; | grep -v node_modules | head -3\r"
expect "*#*"

puts "📋 VERIFICANDO server.js ou app.js..."
send "ls server/server.js server/app.js server/index.js 2>/dev/null\r"
expect "*#*"

send "cat server/server.js | grep -A 10 -B 10 'database\\|Database\\|sqlite\\|postgres'\r"
expect "*#*"

puts "📋 VERIFICANDO DADOS NO SQLITE..."
send "sqlite3 server/database.sqlite \"SELECT name FROM sqlite_master WHERE type='table';\"\r"
expect "*#*"

send "sqlite3 server/database.sqlite \"SELECT COUNT(*) as total_bots FROM bots;\"\r"
expect "*#*"

send "sqlite3 server/database.sqlite \"SELECT id, name FROM bots LIMIT 5;\"\r"
expect "*#*"

puts "📋 VERIFICANDO DADOS NO POSTGRESQL..."
send "psql -U postgres -d deriv_bots_db -c \"\\\\dt\" 2>/dev/null || echo 'Não conseguiu conectar no PostgreSQL'\r"
expect "*#*"

puts "📋 TESTANDO CONEXÃO REAL COM O SERVIDOR..."
send "pm2 logs --lines 10 | grep -i 'database\\|sqlite\\|postgres'\r"
expect "*#*"

interact