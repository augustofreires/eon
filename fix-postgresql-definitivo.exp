#!/usr/bin/expect -f

set timeout 30

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "🔧 CONFIGURAÇÃO DEFINITIVA POSTGRESQL..."

puts "1. Verificando pg_hba.conf atual..."
send "cat /etc/postgresql/16/main/pg_hba.conf | grep -E 'local.*all'\r"
expect "*#*"

puts "2. Configurando pg_hba.conf para md5..."
send "sudo cp /etc/postgresql/16/main/pg_hba.conf /etc/postgresql/16/main/pg_hba.conf.backup\r"
expect "*#*"

send "sudo tee /etc/postgresql/16/main/pg_hba.conf > /dev/null << 'EOF'
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# Local connections
local   all             postgres                                trust
local   all             all                                     md5

# IPv4 local connections:
host    all             all             127.0.0.1/32            md5

# IPv6 local connections:
host    all             all             ::1/128                 md5

EOF\r"
expect "*#*"

puts "3. Configurando senha PostgreSQL..."
send "sudo -u postgres psql -c \"ALTER USER postgres PASSWORD 'postgres123';\"\r"
expect "*#*"

puts "4. Atualizando DATABASE_URL..."
send "cat > server/.env << 'EOF'
DATABASE_URL=postgresql://postgres:postgres123@localhost:5432/eon_platform
NODE_ENV=production
PORT=5000
JWT_SECRET=minha-chave-secreta-muito-longa-e-segura-para-desenvolvimento-12345
JWT_EXPIRES_IN=24h
CORS_ORIGIN=https://iaeon.site
DERIV_APP_ID=82349
DERIV_OAUTH_REDIRECT_URL=https://iaeon.site/operations
EOF\r"
expect "*#*"

puts "5. Reiniciando PostgreSQL..."
send "sudo systemctl restart postgresql\r"
expect "*#*"

puts "6. Testando conexão..."
send "PGPASSWORD=postgres123 psql -U postgres -d eon_platform -c \"SELECT COUNT(*) FROM users;\"\r"
expect "*#*"

puts "7. Reiniciando servidor Node.js..."
send "pm2 restart iaeon-server\r"
expect "*#*"

puts "8. Aguardando estabilização..."
send "sleep 5\r"
expect "*#*"

puts "9. Teste final de login..."
send "curl -s -X POST http://localhost:5000/api/auth/login -H 'Content-Type: application/json' -d '{\"email\":\"cliente@iaeon.com\",\"password\":\"123456\",\"isAdmin\":false}'\r"
expect "*#*"

puts ""
puts "🎉 CONFIGURAÇÃO POSTGRESQL DEFINITIVA CONCLUÍDA!"

interact