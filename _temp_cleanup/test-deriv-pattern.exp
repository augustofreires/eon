#!/usr/bin/expect -f

set timeout 300
set password "62uDLW4RJ9ae28EPVfp5yzT##"

# Connect to VPS
spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no root@31.97.28.231

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "root@" {
        # Connected successfully
        send "cd /root/eon\r"
        expect "root@"

        send "echo '=== TESTING DERIV PATTERN DEPLOYMENT ==='\r"
        expect "root@"

        # Test 1: Check if backend is running
        send "echo '1. Checking backend status...'\r"
        expect "root@"

        send "pm2 status\r"
        expect "root@"

        # Test 2: Check if the backend switch-account endpoint exists
        send "echo '2. Checking switch-account endpoint...'\r"
        expect "root@"

        send "grep -n 'switch-account' server/routes/auth.js | head -5\r"
        expect "root@"

        # Test 3: Test backend API response
        send "echo '3. Testing backend API (unauthorized call should return 401)...'\r"
        expect "root@"

        send "curl -s -o /dev/null -w '%{http_code}' https://iaeon.site/api/auth/deriv/status\r"
        expect "root@"

        # Test 4: Check nginx status
        send "echo '4. Checking nginx status...'\r"
        expect "root@"

        send "systemctl status nginx --no-pager | head -10\r"
        expect "root@"

        # Test 5: Test website accessibility
        send "echo '5. Testing website accessibility...'\r"
        expect "root@"

        send "curl -s -I https://iaeon.site | head -3\r"
        expect "root@"

        # Test 6: Check backend logs for any errors
        send "echo '6. Checking recent backend logs...'\r"
        expect "root@"

        send "pm2 logs eon-backend --lines 5 --nostream\r"
        expect "root@"

        send "echo '=== DERIV PATTERN DEPLOYMENT VERIFICATION COMPLETE ==='\r"
        expect "root@"

        send "echo 'Next step: Test account switching manually at https://iaeon.site'\r"
        expect "root@"

        send "echo 'Expected behavior:'\r"
        expect "root@"

        send "echo '- No AlreadySubscribed errors'\r"
        expect "root@"

        send "echo '- Balance updates immediately when switching accounts'\r"
        expect "root@"

        send "echo '- Clean console logs showing official Deriv pattern'\r"
        expect "root@"

        send "exit\r"
    }
    timeout {
        puts "Connection timeout"
        exit 1
    }
}

expect eof