#!/usr/bin/expect -f

set timeout 60
set password "62uDLW4RJ9ae28EPVfp5yzT##"

# Primeiro fazer upload do arquivo correto
spawn scp -o StrictHostKeyChecking=no -o PreferredAuthentications=password "/Users/augustofreires/Desktop/Bots deriv/client/build/static/js/main.7426e077.js" root@31.97.28.231:/tmp/

expect {
    "*password:" {
        send "$password\r"
        expect eof
    }
}

# Conectar via SSH para fazer deploy
spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "*password:" {
        send "$password\r"
        exp_continue
    }
    "*# " {
        puts "\nğŸš€ DEPLOY FINAL - VERSÃƒO FUNCIONAL DOS BOTS..."

        # Mover arquivo para local correto
        send "mv /tmp/main.7426e077.js /root/eon/client/build/static/js/\r"
        expect "*# "

        # Remover arquivos antigos do nginx
        send "rm -f /var/www/html/static/js/main*.js\r"
        expect "*# "

        # Copiar arquivo correto para nginx
        send "cp /root/eon/client/build/static/js/main.7426e077.js /var/www/html/static/js/\r"
        expect "*# "

        # Verificar arquivo final
        send "ls -la /var/www/html/static/js/main*.js\r"
        expect "*# "

        # CONFIRMAR que tem loadAvailableBots (deve ser 1)
        send "grep -c 'loadAvailableBots' /var/www/html/static/js/main*.js\r"
        expect "*# "

        # Verificar servidor backend
        send "pm2 status iaeon-server\r"
        expect "*# "

        # Reload nginx final
        send "systemctl reload nginx\r"
        expect "*# "

        puts "\nâœ… DEPLOY FINAL CONCLUÃDO!"
        puts "ğŸŒ TESTE AGORA: https://iaeon.site/operations"
        puts ""
        puts "ğŸ¯ CONFIRMAÃ‡Ã•ES FINAIS:"
        puts "   âœ“ main.7426e077.js com correÃ§Ãµes anti-tree-shaking"
        puts "   âœ“ loadAvailableBots presente no arquivo (1 ocorrÃªncia)"
        puts "   âœ“ Backend iaeon-server rodando"
        puts "   âœ“ Nginx recarregado"
        puts ""
        puts "ğŸ”¥ AGORA OS 3 BOTS DEVEM APARECER APÃ“S CONECTAR DERIV!"
        puts "ğŸ“‹ Credenciais: cliente@iaeon.com / 123456"

        send "exit\r"
    }
}

expect eof