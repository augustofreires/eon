#!/usr/bin/expect -f

set timeout 120

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231
expect "password:"
send "abc123@!bD\\.\r"

expect "root@"
send "cd /root/eon\r"

expect "root@"
send "echo '🔍 Verificando se função existe...'\r"

expect "root@"
send "grep -n 'subscribeToBalanceUpdates' client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo '🔧 Adicionando função oficial Deriv...'\r"

expect "root@"
send "cat >> client/src/services/DerivWebSocketService.ts << 'FUNCEOF'\r"
send "\r"
send "  /**\r"
send "   * PADRÃO OFICIAL DERIV: Subscribe to balance updates after authorization\r"
send "   */\r"
send "  private subscribeToBalanceUpdates(): void {\r"
send "    console.log('💰 Subscribing to balance updates (official Deriv pattern)...');\r"
send "\r"
send "    const request = {\r"
send "      balance: 1,\r"
send "      subscribe: 1,\r"
send "      req_id: this.generateRequestId('balance_sub')\r"
send "    };\r"
send "\r"
send "    this.subscribers.set('balance_updates', {\r"
send "      onConnection: (data: any) => {\r"
send "        if (data.balance) {\r"
send "          console.log('💰 DERIV PATTERN: Balance update received:', data.balance);\r"
send "          this.notifySubscribers('onBalance', {\r"
send "            balance: data.balance.balance,\r"
send "            currency: data.balance.currency,\r"
send "            loginid: data.balance.loginid || this.currentAccount\r"
send "          });\r"
send "        }\r"
send "      }\r"
send "    });\r"
send "\r"
send "    this.send(request);\r"
send "    console.log('✅ Balance subscription request sent');\r"
send "  }\r"
send "FUNCEOF\r"

expect "root@"
send "echo '🔗 Adicionando chamada da função...'\r"

expect "root@"
send "sed -i '/this.currentAccount = data.authorize.loginid;/a\\            this.subscribeToBalanceUpdates();' client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo '🔧 Rebuilding frontend...'\r"

expect "root@"
send "npm run build\r"
expect "Successfully"

send "systemctl reload nginx\r"

expect "root@"
send "echo '✅ CORREÇÃO APLICADA COM SUCESSO!'\r"

expect "root@"
send "echo 'Teste agora em https://iaeon.site'\r"

expect "root@"
send "exit\r"

expect eof
puts "🎉 CORREÇÃO OFICIAL DERIV APLICADA!"
