#!/usr/bin/expect -f

set timeout 60
set password "62uDLW4RJ9ae28EPVfp5yzT##"

puts "ğŸš€ Conectando na VPS com autenticaÃ§Ã£o por senha..."

# ForÃ§ar autenticaÃ§Ã£o por senha (nÃ£o usar chaves SSH)
spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "*assword*" {
        send "$password\r"
        expect "*#*"

        puts "âœ… Conectado! Executando deploy..."

        # Ir para diretÃ³rio
        send "cd /var/www/iaeon\r"
        expect "*#*"

        send "pwd\r"
        expect "*#*"

        puts "ğŸ“ DiretÃ³rio confirmado. Iniciando processo..."

        # Fazer backup
        send "mkdir -p /tmp/backup-oauth-\$(date +%Y%m%d-%H%M%S)\r"
        expect "*#*"

        # Usar wget para baixar arquivos do GitHub se necessÃ¡rio, ou criar diretamente
        puts "ğŸ”§ Preparando para aplicar correÃ§Ãµes..."

        # Primeiro vamos ver o que existe
        send "ls -la client/src/contexts/\r"
        expect "*#*"

        send "ls -la client/src/components/\r"
        expect "*#*"

        send "ls -la client/src/pages/\r"
        expect "*#*"

        puts "ğŸ“‹ Estrutura verificada. Pronto para aplicar correÃ§Ãµes."
        puts "ğŸ’¡ Agora vou aplicar as correÃ§Ãµes diretamente..."

        # Aplicar correÃ§Ã£o no AuthContext
        send "cp client/src/contexts/AuthContext.tsx client/src/contexts/AuthContext.tsx.backup\r"
        expect "*#*"

        puts "âœ… Backup criado. Mantendo conexÃ£o para aplicar correÃ§Ãµes..."

        # Manter conexÃ£o interativa para aplicar as correÃ§Ãµes
        interact
    }
    "*yes/no*" {
        send "yes\r"
        exp_continue
    }
    "Connection refused" {
        puts "âŒ ConexÃ£o recusada"
        exit 1
    }
    timeout {
        puts "âŒ Timeout na conexÃ£o"
        exit 1
    }
}