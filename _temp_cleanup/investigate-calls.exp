#!/usr/bin/expect -f

set timeout 30

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "ğŸ” PROCURANDO TODAS AS CHAMADAS DE loadAvailableBots..."

# Encontrar onde a funÃ§Ã£o Ã© chamada
send "grep -n 'loadAvailableBots()' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ” VERIFICANDO O CONTEXTO DA CHAMADA..."

# Ver o contexto em volta da chamada
send "grep -n -A 10 -B 10 'loadAvailableBots()' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ” VERIFICANDO SE HÃ CONDICIONAIS QUE IMPEDEM A EXECUÃ‡ÃƒO..."

# Procurar por ifs que podem impedir a execuÃ§Ã£o
send "sed -n '425,445p' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ” ADICIONANDO ALERT ANTES DA CHAMADA loadAvailableBots..."

# Adicionar alert antes da linha que chama loadAvailableBots
send "sed -i '434i\\          alert(\"ğŸ”¥ PRESTES A CHAMAR loadAvailableBots!\");' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

# Verificar se foi adicionado
send "sed -n '432,438p' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ—ï¸ BUILD COM ALERT ANTES DA CHAMADA..."
send "cd client && npm run build\r"
expect {
    "*build folder is ready*" {
        puts "âœ… Build OK"
    }
    "*compiled successfully*" {
        puts "âœ… Build OK"
    }
    timeout {
        puts "â° Building..."
    }
}
expect "*#*"

send "cd /root/eon && pm2 restart all\r"
expect "*#*"

puts ""
puts "ğŸ”¥ AGORA TESTE NOVAMENTE!"
puts "DEVE APARECER: 'ğŸ”¥ PRESTES A CHAMAR loadAvailableBots!'"
puts "Se nÃ£o aparecer, o cÃ³digo nem chega atÃ© essa linha!"

interact