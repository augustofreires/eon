#!/usr/bin/expect -f

set timeout 120

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231
expect "password:"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"

expect "root@"
send "cd /root/eon\r"

expect "root@"
send "echo '🔄 Restoring clean backup...'\r"

expect "root@"
send "cp client/src/services/DerivWebSocketService.bak client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo '📝 Creating proper function file...'\r"

expect "root@"
send "cat > /tmp/balance_function.txt << 'EOF'\r"
send "\r"
send "  /**\r"
send "   * PADRÃO OFICIAL DERIV: Subscribe to balance updates after authorization\r"
send "   */\r"
send "  private subscribeToBalanceUpdates(): void {\r"
send "    console.log('💰 Subscribing to balance updates (official Deriv pattern)...');\r"
send "\r"
send "    const request = {\r"
send "      balance: 1,\r"
send "      subscribe: 1,\r"
send "      req_id: this.generateRequestId('balance_sub')\r"
send "    };\r"
send "\r"
send "    this.subscribers.set('balance_updates', {\r"
send "      onConnection: (data: any) => {\r"
send "        if (data.balance) {\r"
send "          console.log('💰 DERIV PATTERN: Balance update received:', data.balance);\r"
send "          this.notifySubscribers('onBalance', {\r"
send "            balance: data.balance.balance,\r"
send "            currency: data.balance.currency,\r"
send "            loginid: data.balance.loginid || this.currentAccount\r"
send "          });\r"
send "        }\r"
send "      }\r"
send "    });\r"
send "\r"
send "    this.send(request);\r"
send "    console.log('✅ Balance subscription request sent');\r"
send "  }\r"
send "EOF\r"

expect "root@"
send "echo '📍 Finding insertion line number...'\r"

expect "root@"
send "grep -n 'export default DerivWebSocketService' client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo '📝 Inserting function at correct position...'\r"

expect "root@"
send "head -n 720 client/src/services/DerivWebSocketService.ts > /tmp/before.txt\r"

expect "root@"
send "echo '' >> /tmp/before.txt\r"

expect "root@"
send "cat /tmp/balance_function.txt >> /tmp/before.txt\r"

expect "root@"
send "echo '' >> /tmp/before.txt\r"

expect "root@"
send "tail -n +721 client/src/services/DerivWebSocketService.ts >> /tmp/before.txt\r"

expect "root@"
send "cp /tmp/before.txt client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo '🔗 Adding function call after authorization...'\r"

expect "root@"
send "sed -i '/this.currentAccount = data.authorize.loginid;/a\\            this.subscribeToBalanceUpdates();' client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo '🔧 Building with proper syntax...'\r"

expect "root@"
send "npm run build\r"
expect "Successfully"

send "systemctl reload nginx\r"

expect "root@"
send "echo '✅ SYNTAX-CORRECTED VERSION DEPLOYED!'\r"

expect "root@"
send "exit\r"

expect eof
puts "🎉 SYNTAX FIX COMPLETE!"