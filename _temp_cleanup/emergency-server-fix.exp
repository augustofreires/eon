#!/usr/bin/expect -f

set timeout 60

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
   "password:" {
       send "62uDLW4RJ9ae28EPVfp5yzT##\r"
   }
}

expect "# "
send_user "ğŸš¨ EMERGÃŠNCIA: SERVIDOR NÃƒO ESTÃ FUNCIONANDO!\n\n"

send "cd /root/eon\r"
expect "# "

send_user "1. ğŸ“‹ Verificando logs de erro do PM2:\n"
send "pm2 logs eon-pro-server --err --lines 10\r"
expect "# "

send_user "\n2. ğŸ“Š Verificando status detalhado:\n"
send "pm2 monit\r"
sleep 3
send "\003"
expect "# "

send_user "\n3. ğŸ”§ Tentando iniciar diretamente para ver erros:\n"
send "pm2 stop eon-pro-server\r"
expect "# "
send "cd server && node index.js &\r"
expect "# "
sleep 5

send_user "\n4. ğŸ§ª Testando porta direta:\n"
send "curl -s 'http://localhost:3000/api/health' || echo 'Still not working'\r"
expect "# "

send_user "\n5. ğŸ” Verificando processo Node:\r"
send "ps aux | grep node\r"
expect "# "

send_user "\n6. ğŸ”„ Matando processos e reiniciando PM2:\n"
send "pkill node\r"
expect "# "
send "cd /root/eon\r"
expect "# "
send "pm2 start server/index.js --name eon-pro-server -i 1\r"
expect "# "

send_user "\n7. âœ… Teste final:\n"
send "sleep 5\r"
expect "# "
send "curl -s 'http://localhost:3000/api/health' && echo 'SERVER WORKING!' || echo 'SERVER STILL BROKEN'\r"
expect "# "

interact
