#!/usr/bin/expect -f

set timeout 60

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
   "password:" {
       send "62uDLW4RJ9ae28EPVfp5yzT##\r"
   }
}

expect "# "
send "cd /root/eon\r"
expect "# "

send_user "🔍 DEBUG FINAL DO SERVIDOR\n\n"

send_user "1. Verificando logs de erro completos\n"
send "pm2 logs eon-fixed --err --lines 30\r"
expect "# "

send_user "2. Verificando se o processo está rodando realmente\n"
send "ps aux | grep 'node.*server/index.js'\r"
expect "# "

send_user "3. Verificando porta com netstat\n"
send "netstat -tlnp | grep 5001\r"
expect "# "

send_user "4. Testando conectividade de rede\n"
send "curl -v 'http://localhost:5001/api/health' 2>&1 | head -20\r"
expect "# "

send_user "5. Verificando se tem algum firewall bloqueando\n"
send "ufw status\r"
expect "# "

send_user "6. Parando todos os processos PM2 e testando diretamente\n"
send "pm2 stop all\r"
expect "# "

send "cd server && timeout 10s node index.js\r"
expect "# " timeout 15

send_user "\n🎯 Análise concluída. Problemas identificados!\n"

interact
