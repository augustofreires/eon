#!/usr/bin/expect -f

set timeout 300

# Continuar na sessÃ£o SSH jÃ¡ conectada
puts "ğŸ”„ Continuando deploy..."

# Simular que jÃ¡ estamos conectados
expect "# "

# Fazer backup do build atual
send "cp -r client/build client/build.backup.websocket\r"
expect "# "

# Aplicar novo build
send "rm -rf client/build\r"
expect "# "

send "mv /tmp/websocket-build/build client/\r"
expect "# "

# Definir permissÃµes corretas
send "chown -R www-data:www-data client/build\r"
expect "# "

send "chmod -R 755 client/build\r"
expect "# "

# Verificar se aplicou corretamente
send "ls -la client/build/\r"
expect "# "

# Reiniciar PM2
puts "ğŸ”„ Reiniciando PM2..."
send "pm2 restart iaeon-server\r"
expect "# "

# Verificar PM2
send "pm2 status\r"
expect "# "

# Testar se estÃ¡ funcionando
puts "ğŸ§ª Testando o servidor..."
send "curl -I http://localhost:3001\r"
expect "# "

puts "\nâœ… Deploy das melhorias de WebSocket concluÃ­do!"
puts "ğŸŒ Teste agora: https://iaeon.site"

interact