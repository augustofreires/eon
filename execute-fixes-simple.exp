#!/usr/bin/expect -f

set timeout 300

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "ğŸ’¾ Backup..."
send "cp ./client/src/contexts/AuthContext.tsx /tmp/AuthContext.backup\r"
expect "*#*"

puts "ğŸ”§ Fix 1: AuthContext interface..."
send "sed -i 's/switchAccount: (account: DerivAccount) => Promise<void>;/switchAccount: (account: DerivAccount, manual?: boolean) => Promise<void>;/' ./client/src/contexts/AuthContext.tsx\r"
expect "*#*"

puts "ğŸ”§ Fix 2: AuthContext function..."
send "sed -i 's/const switchAccount = async (account: DerivAccount) => {/const switchAccount = async (account: DerivAccount, manual: boolean = false) => {/' ./client/src/contexts/AuthContext.tsx\r"
expect "*#*"

puts "ğŸ”§ Fix 3: DerivAccountPanel..."
send "sed -i 's/await switchAccount(account);/await switchAccount(account, true);/' ./client/src/components/DerivAccountPanel.tsx\r"
expect "*#*"

puts "ğŸ—ï¸ Build..."
send "cd client && npm run build\r"
expect {
    "*build folder is ready*" {
        puts "âœ… Build OK"
    }
    "*compiled successfully*" {
        puts "âœ… Build OK"
    }
    timeout {
        puts "â° Timeout build"
    }
}
expect "*#*"

puts "ğŸ”„ PM2 restart..."
send "cd /root/eon && pm2 restart all\r"
expect "*#*"

puts "ğŸ‰ CONCLUÃDO!"
puts "ğŸ§ª TESTE: https://iaeon.site/operations"

send "exit\r"
expect eof