#!/usr/bin/expect -f

set timeout 30

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
   "password:" {
       send "62uDLW4RJ9ae28EPVfp5yzT##\r"
   }
}

expect "# "
send "cd /root/eon\r"
expect "# "

send_user "ğŸ” INVESTIGANDO PROBLEMA NO /get-token...\n"

# Verificar se o cÃ³digo estÃ¡ mesmo deployado
send_user "\nğŸ“‹ 1. Verificando se o cÃ³digo foi deployado:\n"
send "grep -A10 -B5 'CORREÃ‡ÃƒO CRÃTICA.*Buscar token especÃ­fico' server/routes/auth.js\r"
expect "# "

send_user "\nğŸ“‹ 2. Verificando endpoint get-token:\n"
send "grep -A15 -B5 'get-token' server/routes/auth.js\r"
expect "# "

send_user "\nğŸ“‹ 3. Testando requisiÃ§Ã£o direta ao get-token:\n"
send "curl -s 'http://localhost:3000/api/auth/deriv/get-token' -H 'Authorization: Bearer VALID_JWT_HERE' | jq .\r"
expect "# "

send_user "\nğŸ“‹ 4. Verificando logs do get-token em tempo real:\n"
send "pm2 logs eon-pro-server --lines 0 | grep --line-buffered 'get-token\\|Getting token\\|Found specific token' &\r"
expect "# "

send_user "\nâ° Agora teste get-token no browser por 20 segundos...\n"
send "sleep 20\r"
expect "# "

send "pkill tail\r"
expect "# "

interact
