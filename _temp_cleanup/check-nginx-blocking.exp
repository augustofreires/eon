#!/usr/bin/expect -f

set timeout 30

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
    }
}

expect "# "
send "cd /root/eon\r"
expect "# "

send_user "🔍 VERIFICANDO SE NGINX ESTÁ BLOQUEANDO REQUISIÇÕES...\n"

# Verificar logs de erro do nginx
send_user "📋 Logs de erro do nginx:\n"
send "tail -20 /var/log/nginx/error.log | grep -E '400|block|deny|switch-account'\r"
expect "# "

send_user "\n📋 Logs de acesso do nginx:\n"
send "tail -20 /var/log/nginx/access.log | grep -E 'POST.*switch-account|400'\r"
expect "# "

send_user "\n🔍 Verificando configuração do nginx:\n"
send "nginx -t\r"
expect "# "

send_user "\n🔍 Verificando se há rate limiting específico:\n"
send "grep -r 'limit_req' /etc/nginx/ 2>/dev/null | head -5\r"
expect "# "

send_user "\n🧪 Testando POST direto via nginx:\n"
send "curl -v -X POST 'http://localhost/api/auth/deriv/switch-account' -H 'Content-Type: application/json' -H 'Authorization: Bearer test' -d '{\"test\":\"test\"}' 2>&1 | head -10\r"
expect "# "

interact