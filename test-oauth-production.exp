#!/usr/bin/expect -f

set timeout 60

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "password:"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"

expect "root@"

send "cd /root/eon\r"
expect "root@"

# Test login to get JWT token
send "echo '=== TESTANDO LOGIN PARA OBTER JWT TOKEN ==='\\r"
expect "root@"

send "curl -s -X POST http://localhost:3001/api/auth/login -H 'Content-Type: application/json' -d '{\\\"email\\\":\\\"admin@iaeon.com\\\",\\\"password\\\":\\\"admin123\\\"}' | jq .\\r"
expect "root@"

send "TOKEN=\\$(curl -s -X POST http://localhost:3001/api/auth/login -H 'Content-Type: application/json' -d '{\\\"email\\\":\\\"admin@iaeon.com\\\",\\\"password\\\":\\\"admin123\\\"}' | jq -r .token)\\r"
expect "root@"

send "echo 'JWT Token obtido: '\\$TOKEN\\r"
expect "root@"

# Test Deriv status endpoint with JWT
send "echo '=== TESTANDO /api/auth/deriv/status COM JWT ==='\\r"
expect "root@"

send "curl -H \\\"Authorization: Bearer \\$TOKEN\\\" http://localhost:3001/api/auth/deriv/status\\r"
expect "root@"

# Test account-info endpoint with JWT
send "echo '=== TESTANDO /api/auth/deriv/account-info COM JWT ==='\\r"
expect "root@"

send "curl -H \\\"Authorization: Bearer \\$TOKEN\\\" http://localhost:3001/api/auth/deriv/account-info\\r"
expect "root@"

# Test fetch-all-accounts endpoint with JWT
send "echo '=== TESTANDO /api/auth/deriv/fetch-all-accounts COM JWT ==='\\r"
expect "root@"

send "curl -X POST -H \\\"Authorization: Bearer \\$TOKEN\\\" -H 'Content-Type: application/json' http://localhost:3001/api/auth/deriv/fetch-all-accounts\\r"
expect "root@"

# Check server logs for any errors
send "echo '=== VERIFICANDO LOGS DO SERVIDOR ==='\\r"
expect "root@"

send "tail -10 server_final.log\\r"
expect "root@"

puts ""
puts "âœ… TESTES DE PRODUÃ‡ÃƒO CONCLUÃDOS!"
puts ""
puts "ğŸŒ Agora teste manualmente:"
puts "1. Acesse: https://iaeon.site"
puts "2. Login: admin@iaeon.com / admin123"
puts "3. VÃ¡ para OperaÃ§Ãµes > Painel de OperaÃ§Ãµes"
puts "4. Clique em 'Conectar com Deriv'"
puts "5. FaÃ§a OAuth e teste troca de contas"
puts ""
puts "ğŸ” JWT tokens agora sÃ£o incluÃ­dos automaticamente!"

send "exit\r"
expect eof