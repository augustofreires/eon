#!/usr/bin/expect -f

set timeout 30

# Deploy da correÃ§Ã£o OAuth
puts "ğŸš€ Iniciando deploy da correÃ§Ã£o OAuth..."

# Enviar AuthContext.tsx
puts "ğŸ“¤ Enviando AuthContext.tsx..."
spawn scp -o StrictHostKeyChecking=no client/src/contexts/AuthContext.tsx root@31.97.28.231:/var/www/iaeon/client/src/contexts/
expect {
    "*password*" { send "62uDLW4RJ9ae28EPVfp5yzT##\r"; exp_continue }
    "*yes/no*" { send "yes\r"; exp_continue }
    eof
}

# Enviar DerivAccountPanel.tsx
puts "ğŸ“¤ Enviando DerivAccountPanel.tsx..."
spawn scp -o StrictHostKeyChecking=no client/src/components/DerivAccountPanel.tsx root@31.97.28.231:/var/www/iaeon/client/src/components/
expect {
    "*password*" { send "62uDLW4RJ9ae28EPVfp5yzT##\r"; exp_continue }
    "*yes/no*" { send "yes\r"; exp_continue }
    eof
}

# Enviar OperationsPage.tsx
puts "ğŸ“¤ Enviando OperationsPage.tsx..."
spawn scp -o StrictHostKeyChecking=no client/src/pages/OperationsPage.tsx root@31.97.28.231:/var/www/iaeon/client/src/pages/
expect {
    "*password*" { send "62uDLW4RJ9ae28EPVfp5yzT##\r"; exp_continue }
    "*yes/no*" { send "yes\r"; exp_continue }
    eof
}

# Enviar setup.js
puts "ğŸ“¤ Enviando setup.js..."
spawn scp -o StrictHostKeyChecking=no server/database/setup.js root@31.97.28.231:/var/www/iaeon/server/database/
expect {
    "*password*" { send "62uDLW4RJ9ae28EPVfp5yzT##\r"; exp_continue }
    "*yes/no*" { send "yes\r"; exp_continue }
    eof
}

puts "âœ… Arquivos enviados!"

# Conectar e executar comandos
puts "ğŸ”§ Executando build e restart..."
spawn ssh -o StrictHostKeyChecking=no root@31.97.28.231

expect {
    "*password*" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
        expect "*#*"

        # Comandos na VPS
        send "cd /var/www/iaeon\r"
        expect "*#*"

        send "echo 'ğŸ’¾ Fazendo backup...'\r"
        expect "*#*"

        send "mkdir -p /tmp/backup-oauth-\$(date +%Y%m%d-%H%M%S)\r"
        expect "*#*"

        send "echo 'ğŸ—ï¸ Build do cliente...'\r"
        expect "*#*"

        send "cd client\r"
        expect "*#*"

        send "rm -rf build/\r"
        expect "*#*"

        send "npm run build\r"
        expect {
            "*build folder is ready*" {
                send "echo 'âœ… Build concluÃ­do!'\r"
                expect "*#*"
            }
            "*error*" {
                send "echo 'âŒ Erro no build'\r"
                expect "*#*"
            }
            timeout {
                send "echo 'â° Build em andamento...'\r"
                expect "*#*"
            }
        }

        send "cd /var/www/iaeon\r"
        expect "*#*"

        send "echo 'ğŸ”„ Reiniciando PM2...'\r"
        expect "*#*"

        send "pm2 restart all\r"
        expect "*#*"

        send "pm2 status\r"
        expect "*#*"

        send "echo '\rğŸ‰ DEPLOY CONCLUÃDO!'\r"
        expect "*#*"

        send "echo 'ğŸ§ª Teste: https://iaeon.site/operations'\r"
        expect "*#*"

        send "echo 'ğŸ‘¤ Login: cliente@iaeon.com / 123456'\r"
        expect "*#*"

        send "exit\r"
    }
    "*yes/no*" {
        send "yes\r"
        exp_continue
    }
    eof
}

puts "\nğŸ¯ CORREÃ‡ÃƒO OAUTH DEPLOYADA!"
puts "============================="
puts "ğŸ§ª TESTE AGORA: https://iaeon.site/operations"