#!/usr/bin/expect -f

set timeout 30
spawn ssh root@31.97.28.231

expect {
    "*password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
        exp_continue
    }
    "*# " {
        # Fazer backup e aplicar correções
        send "cd /root/Bots\\ deriv\r"
        expect "*# "

        # Verificar status
        send "git status\r"
        expect "*# "

        # Fazer pull das alterações
        send "git pull origin main\r"
        expect "*# "

        # Parar serviços
        send "pm2 stop all\r"
        expect "*# "

        # Instalar dependências se necessário
        send "cd client && npm install\r"
        expect "*# "

        # Build do client
        send "npm run build\r"
        expect "*# "

        # Voltar para server
        send "cd ../server && npm install\r"
        expect "*# "

        # Iniciar servidor
        send "pm2 start index.js --name bot-server\r"
        expect "*# "

        # Verificar logs
        send "pm2 logs bot-server --lines 20\r"
        expect "*# "

        send "exit\r"
    }
    timeout {
        puts "Timeout na conexão"
        exit 1
    }
}

expect eof