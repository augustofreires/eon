#!/usr/bin/expect -f

set timeout 300
set password "62uDLW4RJ9ae28EPVfp5yzT##"

spawn ssh root@31.97.28.231

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        puts "\nâœ… Conectado ao VPS"
    }
    timeout {
        puts "âŒ Timeout na conexÃ£o SSH"
        exit 1
    }
}

# Navegar para o diretÃ³rio do projeto
send "cd /var/www/deriv-bots\r"
expect "# "

# Fazer backup do build atual
send "cp -r client/build client/build.backup.$(date +%Y%m%d_%H%M%S)\r"
expect "# "

# Criar diretÃ³rio temporÃ¡rio
send "mkdir -p /tmp/new-build\r"
expect "# "

puts "\nğŸ”„ Fazendo upload do novo build..."

# Sair da sessÃ£o SSH para fazer upload
send "exit\r"
expect eof

# Upload do build via SCP
spawn scp -r /Users/augustofreires/Desktop/Bots\ deriv/client/build/ root@31.97.28.231:/tmp/new-build/
expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {
        puts "\nâœ… Upload do build concluÃ­do"
    }
}

# Reconectar para aplicar as mudanÃ§as
spawn ssh root@31.97.28.231

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        puts "\nâœ… Reconectado ao VPS"
    }
}

# Aplicar o novo build
send "cd /var/www/deriv-bots\r"
expect "# "

send "rm -rf client/build\r"
expect "# "

send "mv /tmp/new-build/build client/\r"
expect "# "

send "chown -R www-data:www-data client/build\r"
expect "# "

send "chmod -R 755 client/build\r"
expect "# "

# Reiniciar serviÃ§os
puts "\nğŸ”„ Reiniciando serviÃ§os..."

send "pm2 restart all\r"
expect "# "

send "systemctl restart nginx\r"
expect "# "

# Verificar se os serviÃ§os estÃ£o rodando
puts "\nğŸ” Verificando status dos serviÃ§os..."

send "pm2 status\r"
expect "# "

send "systemctl status nginx --no-pager -l\r"
expect "# "

# Testar se o site estÃ¡ funcionando
puts "\nğŸ§ª Testando o site..."
send "curl -I http://localhost:3000\r"
expect "# "

puts "\nâœ… Deploy das melhorias de WebSocket concluÃ­do!"
puts "ğŸ” Teste manualmente: https://iaeon.site"
puts "âš ï¸  Verifique se a reconexÃ£o apÃ³s refresh e troca de contas estÃ¡ funcionando"

send "exit\r"
expect eof