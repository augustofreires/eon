#!/usr/bin/expect -f

set timeout 120

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "🔧 Corrigindo acesso aos dados dos bots..."

# Primeiro fazer backup
send "cp ./client/src/pages/OperationsPage.tsx ./client/src/pages/OperationsPage.tsx.backup-bots\r"
expect "*#*"

# Aplicar correção linha por linha
send "sed -i '102s/response.data/response.data.bots || response.data/' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

# Verificar a mudança
send "sed -n '100,105p' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "🏗️ Build..."
send "cd client && npm run build\r"
expect {
    "*build folder is ready*" {
        puts "✅ Build OK"
    }
    "*compiled successfully*" {
        puts "✅ Build OK"
    }
    timeout {
        puts "⏰ Build..."
    }
}
expect "*#*"

puts "🔄 Restart..."
send "cd /root/eon && pm2 restart all\r"
expect "*#*"

puts "🎉 BOTS CORRIGIDOS!"
puts "🧪 Teste: https://iaeon.site/operations"

send "exit\r"
expect eof