#!/usr/bin/expect -f

set timeout 60

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
   "password:" {
       send "62uDLW4RJ9ae28EPVfp5yzT##\r"
   }
}

expect "# "
send_user "ğŸš€ CORREÃ‡ÃƒO DEFINITIVA DO SERVIDOR!\n\n"

send "cd /root/eon\r"
expect "# "

send_user "1. ğŸ”§ Corrigindo trust proxy para modo especÃ­fico:\n"
send "sed -i 's/app.set(\"trust proxy\", true);/app.set(\"trust proxy\", 1);/' server/index.js\r"
expect "# "

send_user "2. ğŸ”§ Adicionando configuraÃ§Ã£o de rate limit para proxy:\n"
send "sed -i '/max: parseInt(process.env.RATE_LIMIT_MAX_REQUESTS) || 1000,/a\\  standardHeaders: true,\\n  legacyHeaders: false,' server/index.js\r"
expect "# "

send_user "3. ğŸ“‹ Verificando correÃ§Ãµes aplicadas:\n"
send "grep -A3 -B1 'trust proxy' server/index.js\r"
expect "# "

send_user "\n4. ğŸ”„ Reiniciando servidor:\n"
send "pm2 restart eon-pro-server\r"
expect "# "

send_user "\n5. â° Aguardando estabilizaÃ§Ã£o:\n"
send "sleep 10\r"
expect "# "

send_user "\n6. ğŸ§ª TESTE CRÃTICO - Porta 5001:\n"
send "curl -s 'http://localhost:5001/api/health' && echo 'âœ… SERVIDOR FUNCIONANDO!' || echo 'âŒ Ainda quebrado'\r"
expect "# "

send_user "\n7. ğŸ“¡ Monitoramento final - TROQUE DE CONTA AGORA!\n"
send "pm2 logs eon-pro-server --lines 0 | grep --line-buffered -E 'get-token|switch-account|CRITICAL|POST|Started' &\r"
expect "# "

send_user "\nğŸ¯ AGORA TESTE A TROCA DE CONTA - SERVIDOR DEVE ESTAR FUNCIONANDO!\n"
send "sleep 25\r"
expect "# "

send "pkill tail\r"
expect "# "

send_user "\nâœ… Se o servidor estÃ¡ respondendo, as correÃ§Ãµes devem funcionar agora!\n"

interact
