#!/usr/bin/expect -f

set timeout 60

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "ğŸ” INVESTIGANDO QUANDO loadAvailableBots Ã‰ CHAMADO..."

# Procurar todas as chamadas de loadAvailableBots
send "grep -n 'loadAvailableBots' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ” VERIFICANDO A FUNÃ‡ÃƒO COMPLETA loadAvailableBots..."

# Ver a funÃ§Ã£o completa
send "sed -n '/const loadAvailableBots/,/}/p' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ” VERIFICANDO SE HÃ USEEFFECT QUE CHAMA loadAvailableBots..."

# Procurar useEffect que chama loadAvailableBots
send "grep -n -A 5 -B 5 'useEffect.*loadAvailableBots' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ” VERIFICANDO SE HÃ CONDITIONAL QUE IMPEDE A CHAMADA..."

# Ver condiÃ§Ãµes em volta de loadAvailableBots
send "grep -n -A 10 -B 10 'loadAvailableBots()' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ” ADICIONANDO LOG NO INÃCIO DA FUNÃ‡ÃƒO..."

# Backup
send "cp ./client/src/pages/OperationsPage.tsx ./client/src/pages/OperationsPage.tsx.debug2\r"
expect "*#*"

# Adicionar log bem no inÃ­cio da funÃ§Ã£o
send "sed -i '/const loadAvailableBots = async () => {/a\\    console.log(\"ğŸš¨ FUNÃ‡ÃƒO loadAvailableBots CHAMADA!\");\\n    console.log(\"ğŸ” availableBots atual:\", availableBots);' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

# Adicionar log em cada if/else que pode impedir a execuÃ§Ã£o
send "sed -i '/if.*connected.*deriv/i\\    console.log(\"âš ï¸ Verificando se Deriv estÃ¡ conectado...\");' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ—ï¸ REBUILD COM LOGS DETALHADOS..."
send "cd client && npm run build\r"
expect {
    "*build folder is ready*" {
        puts "âœ… Build OK"
    }
    "*compiled successfully*" {
        puts "âœ… Build OK"
    }
    timeout {
        puts "â° Building..."
    }
}
expect "*#*"

send "cd /root/eon && pm2 restart all\r"
expect "*#*"

puts ""
puts "ğŸ” LOGS ADICIONADOS!"
puts "==================="
puts ""
puts "ğŸ§ª AGORA TESTE E ABRA DEVTOOLS:"
puts "   1. https://iaeon.site/operations"
puts "   2. Login: cliente@iaeon.com / 123456"
puts "   3. F12 -> Console"
puts "   4. Conecte Deriv"
puts "   5. PROCURE por 'ğŸš¨ FUNÃ‡ÃƒO loadAvailableBots CHAMADA!'"
puts ""
puts "â“ SE NÃƒO APARECER essa mensagem, a funÃ§Ã£o NEM estÃ¡ sendo chamada!"

interact