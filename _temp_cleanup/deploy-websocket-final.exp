#!/usr/bin/expect -f

set timeout 300
set password "62uDLW4RJ9ae28EPVfp5yzT##"

# Primeiro, criar diretÃ³rio temporÃ¡rio e fazer upload
puts "ğŸ”„ Criando diretÃ³rio temporÃ¡rio no servidor..."
spawn ssh root@31.97.28.231 "mkdir -p /tmp/websocket-build"

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {
        puts "âœ… DiretÃ³rio criado"
    }
}

# Upload do build
puts "ğŸ“¦ Fazendo upload do build..."
spawn scp -r /Users/augustofreires/Desktop/Bots\ deriv/client/build/ root@31.97.28.231:/tmp/websocket-build/

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {
        puts "âœ… Upload concluÃ­do"
    }
}

# Conectar e aplicar mudanÃ§as
puts "ğŸ”— Conectando para aplicar mudanÃ§as..."
spawn ssh root@31.97.28.231

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        puts "âœ… Conectado ao VPS"
    }
}

# Navegar para o projeto correto
send "cd /root/eon\r"
expect "# "

# Verificar estrutura
send "ls -la\r"
expect "# "

# Fazer backup do build atual
send "cp -r client/build client/build.backup.websocket\r"
expect "# "

# Aplicar novo build
send "rm -rf client/build\r"
expect "# "

send "mv /tmp/websocket-build/build client/\r"
expect "# "

# Definir permissÃµes corretas
send "chown -R www-data:www-data client/build\r"
expect "# "

send "chmod -R 755 client/build\r"
expect "# "

# Verificar se aplicou corretamente
send "ls -la client/build/\r"
expect "# "

# Reiniciar PM2
puts "ğŸ”„ Reiniciando PM2..."
send "pm2 restart iaeon-server\r"
expect "# "

# Verificar PM2
send "pm2 status\r"
expect "# "

# Reiniciar nginx tambÃ©m
send "systemctl restart nginx\r"
expect "# "

# Testar se estÃ¡ funcionando
puts "ğŸ§ª Testando o servidor..."
send "curl -I http://localhost:3001\r"
expect "# "

puts "\nâœ… Deploy das melhorias de WebSocket concluÃ­do!"
puts "ğŸŒ Teste agora: https://iaeon.site"
puts ""
puts "ğŸ§ª Verifique se as melhorias funcionam:"
puts "   âœ“ ReconexÃ£o automÃ¡tica apÃ³s refresh da pÃ¡gina"
puts "   âœ“ AtualizaÃ§Ã£o do saldo ao trocar conta real/virtual"
puts "   âœ“ PersistÃªncia da conexÃ£o WebSocket"
puts ""
puts "ğŸ” Para debug, veja os logs:"
puts "   pm2 logs iaeon-server"

send "exit\r"
expect eof