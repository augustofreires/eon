#!/usr/bin/expect -f

set timeout 15

spawn ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no root@31.97.28.231

expect {
    "password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
        exp_continue
    }
    "Enter passphrase" {
        send "\r"
        exp_continue
    }
    "root@" {
        send "cd /root/eon\r"
    }
}

expect "root@"
send "echo '=== TESTANDO API DE PRODUCAO COM JWT ==='\r"

expect "root@"
send "# Primeiro vamos pegar um token de teste\r"

expect "root@"
send "JWT_TOKEN=\\$(curl -s -X POST https://iaeon.site/api/auth/login -H 'Content-Type: application/json' -d '{\"email\":\"augusto@gmail.com\",\"password\":\"123456\",\"isAdmin\":false}' | jq -r '.token' 2>/dev/null)\r"

expect "root@"
send "echo \"Token obtido: \\$JWT_TOKEN\"\r"

expect "root@"
send "echo '=== TESTANDO STATUS DERIV COM TOKEN ==='\r"

expect "root@"
send "curl -s -H \"Authorization: Bearer \\$JWT_TOKEN\" https://iaeon.site/api/auth/deriv/status | jq .\r"

expect "root@"
send "echo '=== TESTANDO FETCH ACCOUNTS ==='\r"

expect "root@"
send "curl -s -H \"Authorization: Bearer \\$JWT_TOKEN\" https://iaeon.site/api/auth/deriv/accounts | jq .\r"

expect "root@"
send "exit\r"

expect eof