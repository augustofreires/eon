#!/usr/bin/expect -f

set timeout 300
set password "62uDLW4RJ9ae28EPVfp5yzT##"

# Upload do backend corrigido
puts "📦 Fazendo upload do servidor corrigido..."
spawn scp server/routes/auth.js root@31.97.28.231:/root/eon/server/routes/

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {
        puts "✅ Backend upload concluído"
    }
}

# Upload do frontend atualizado
spawn ssh root@31.97.28.231 "mkdir -p /tmp/balance-fix-build"

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {}
}

puts "📦 Fazendo upload do frontend..."
spawn scp -r /Users/augustofreires/Desktop/Bots\ deriv/client/build/ root@31.97.28.231:/tmp/balance-fix-build/

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {
        puts "✅ Frontend upload concluído"
    }
}

# Conectar e aplicar mudanças
puts "🔗 Conectando para aplicar correção..."
spawn ssh root@31.97.28.231

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        puts "✅ Conectado ao VPS"
    }
}

send "cd /root/eon\r"
expect "# "

# Aplicar frontend
send "rm -rf client/build\r"
expect "# "

send "mv /tmp/balance-fix-build/build client/\r"
expect "# "

send "chown -R www-data:www-data client/build\r"
expect "# "

send "chmod -R 755 client/build\r"
expect "# "

# Reiniciar PM2
puts "🔄 Reiniciando servidor..."
send "pm2 restart iaeon-server\r"
expect "# "

send "pm2 status\r"
expect "# "

puts "\n✅ Correção de saldo aplicada!"
puts "🌐 Teste agora: https://iaeon.site"
puts "🧪 Ao trocar contas, o saldo deve ser exibido corretamente"

send "exit\r"
expect eof