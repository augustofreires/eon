#!/usr/bin/expect -f

set timeout 30

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "üîç TESTANDO CONEX√ÉO POSTGRESQL..."

# Teste direto PostgreSQL
send "PGPASSWORD=postgres123 psql -U postgres -d eon_platform -c \"SELECT COUNT(*) FROM users;\"\r"
expect "*#*"

# Teste com Node.js
send "node -e \"
const { Pool } = require('pg');
const pool = new Pool({
  connectionString: 'postgresql://postgres:postgres123@localhost:5432/eon_platform'
});
pool.query('SELECT COUNT(*) as count FROM users', (err, res) => {
  if (err) {
    console.log('‚ùå ERRO Node.js:', err.message);
  } else {
    console.log('‚úÖ SUCESSO Node.js:', res.rows[0]);
  }
  pool.end();
});
\"\r"
expect "*#*"

# Verificar logs PM2
send "pm2 logs iaeon-server --lines 3\r"
expect "*#*"

interact