{
  "meta": {
    "project_name": "Deriv Trading Bots Panel",
    "last_updated": "2026-01-09",
    "current_version": "0.5.0",
    "main_branch": "main"
  },

  "stack": {
    "frontend": "React + TypeScript (client/src)",
    "backend": "Node.js + Express (server/)",
    "database": "PostgreSQL",
    "auth": "Deriv OAuth 2.0",
    "api": "Deriv WebSocket API"
  },

  "implemented_features": [
    {
      "id": "DERIV-AUTH-001",
      "description": "OAuth login com Deriv API",
      "status": "done",
      "files": [
        "server/routes/auth.js (backend - GET /api/auth/deriv/authorize + GET /api/auth/deriv/callback)",
        "client/src/components/TradingPanel.tsx (frontend - handleOAuthConnect + handleOAuthMessage)"
      ],
      "notes": "Popup OAuth abre corretamente, usu√°rio autentica na Deriv. postMessage j√° implementado no backend (linha 1092). Listener j√° implementado no frontend."
    },
    {
      "id": "DERIV-AUTH-002",
      "description": "Salvar contas OAuth na tabela deriv_accounts",
      "status": "done",
      "files": [
        "server/routes/auth.js"
      ],
      "notes": "Ao fazer OAuth, as contas s√£o salvas corretamente no banco"
    },
    {
      "id": "DERIV-BALANCE-001",
      "description": "Endpoint para buscar saldo real da conta",
      "status": "done",
      "files": [
        "server/routes/auth.js (GET /api/auth/deriv/balance)"
      ],
      "notes": "Retorna saldo real da conta ativa"
    },
    {
      "id": "DERIV-SWITCH-001",
      "description": "Troca de contas Deriv",
      "status": "done",
      "files": [
        "server/routes/auth.js (POST /api/auth/deriv/switch-account)",
        "client/src/components/TradingPanel.tsx (AccountSwitcher integrado)"
      ],
      "notes": "Usu√°rio consegue trocar entre contas e o saldo atualiza corretamente"
    },
    {
      "id": "DERIV-DISCONNECT-001",
      "description": "Bot√£o de desconectar conta Deriv",
      "status": "done",
      "files": [
        "client/src/components/TradingPanel.tsx"
      ],
      "notes": "Permite desconectar e reconectar com nova conta"
    },
    {
      "id": "DERIV-AUTO-REFRESH-001",
      "description": "Atualiza√ß√£o autom√°tica da UI ap√≥s OAuth sem reload",
      "status": "done",
      "files": [
        "client/src/components/TradingPanel.tsx (handleOAuthMessage - linha 328-334)"
      ],
      "notes": "Ap√≥s OAuth: updateUser() atualiza contexto + fetchAccounts() carrega contas ‚Üí UI atualiza automaticamente sem window.location.reload()"
    }
  ],

  "known_bugs": [],

  "decisions": [
    {
      "id": "DEC-001",
      "decision": "Usar OAuth da Deriv ao inv√©s de API tokens diretos",
      "reason": "Seguran√ßa e experi√™ncia do usu√°rio melhorada",
      "date": "2026-01-08"
    },
    {
      "id": "DEC-002",
      "decision": "Salvar contas na tabela deriv_accounts separada",
      "reason": "Permitir m√∫ltiplas contas Deriv por usu√°rio",
      "date": "2026-01-08"
    },
    {
      "id": "DEC-003",
      "decision": "Usar popup para OAuth ao inv√©s de redirect",
      "reason": "Melhor UX, n√£o perde contexto da p√°gina",
      "date": "2026-01-09"
    },
    {
      "id": "DEC-004",
      "decision": "Remover rota duplicada /api/auth/deriv/switch-account",
      "reason": "Havia conflito entre vers√µes GET e POST",
      "date": "2026-01-09"
    }
  ],

  "current_focus": "Fluxo OAuth completo implementado e funcionando",

  "todo": [],

  "constraints": [
    "N√£o modificar tabelas do banco de dados sem necessidade",
    "Manter compatibilidade com c√≥digo de bots existente",
    "Seguir padr√µes Next.js App Router",
    "Sempre testar OAuth flow completo antes de considerar conclu√≠do"
  ],

  "database_schema": {
    "deriv_accounts": {
      "columns": [
        "id (serial primary key)",
        "user_id (integer, FK para users)",
        "account_id (text, ID da conta Deriv)",
        "token (text, OAuth token)",
        "currency (varchar(10))",
        "login_id (text)",
        "is_active (boolean)",
        "created_at (timestamp)",
        "updated_at (timestamp)"
      ]
    }
  },

  "important_endpoints": [
    {
      "path": "/api/auth/deriv/authorize",
      "method": "GET",
      "description": "Retorna URL de autoriza√ß√£o OAuth da Deriv"
    },
    {
      "path": "/api/auth/deriv/callback",
      "method": "GET",
      "description": "Callback OAuth, salva token e contas no banco, envia postMessage para fechar popup"
    },
    {
      "path": "/api/auth/deriv/all-accounts",
      "method": "GET",
      "description": "Retorna todas as contas Deriv do usu√°rio (da tabela deriv_accounts)"
    },
    {
      "path": "/api/auth/deriv/balance",
      "method": "GET",
      "description": "Retorna saldo real da conta ativa via Deriv API"
    },
    {
      "path": "/api/auth/deriv/switch-account",
      "method": "POST",
      "description": "Troca conta ativa do usu√°rio (atualiza is_active no banco)"
    },
    {
      "path": "/api/profile",
      "method": "GET",
      "description": "Retorna dados do usu√°rio autenticado (usado para verificar deriv_connected)"
    }
  ],

  "notes": [
    "√öLTIMO COMMIT (723d745): Corrigir type do postMessage OAuth",
    "üêõ BUG RAIZ ENCONTRADO E CORRIGIDO (2026-01-09 18:02): redirect_uri estava apontando para frontend React",
    "PROBLEMA: DERIV_OAUTH_REDIRECT_URL = '/operations' (frontend) ‚ùå",
    "SOLU√á√ÉO: DERIV_OAUTH_REDIRECT_URL = '/api/auth/deriv/callback' (backend) ‚úÖ",
    "‚úÖ CORRE√á√ÉO APLICADA: .env atualizado + PM2 restartado (PID 42837) com --update-env",
    "‚úÖ Agora o popup carrega HTML do backend (com script postMessage) ao inv√©s do React app",
    "‚úÖ Fluxo OAuth CORRETO: Deriv redireciona ‚Üí /api/auth/deriv/callback (backend) ‚Üí HTML renderizado no popup ‚Üí script envia postMessage ‚Üí popup fecha em 500ms ‚Üí updateUser() + fetchAccounts() ‚Üí UI atualiza automaticamente",
    "Testar em: https://app.zapconverse.com/operations ‚Üí Conectar Deriv ‚Üí Popup deve mostrar HTML de sucesso e fechar automaticamente"
  ]
}
