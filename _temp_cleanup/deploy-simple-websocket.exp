#!/usr/bin/expect -f

set timeout 300
set password "62uDLW4RJ9ae28EPVfp5yzT##"

# Primeiro, fazer upload do build
puts "🔄 Fazendo upload do build..."
spawn scp -r /Users/augustofreires/Desktop/Bots\ deriv/client/build/ root@31.97.28.231:/tmp/websocket-build/

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {
        puts "✅ Upload concluído"
    }
    timeout {
        puts "❌ Timeout no upload"
        exit 1
    }
}

# Conectar via SSH e aplicar mudanças
puts "🔗 Conectando ao VPS..."
spawn ssh root@31.97.28.231

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        puts "✅ Conectado ao VPS"
    }
    timeout {
        puts "❌ Timeout na conexão"
        exit 1
    }
}

# Navegar para o projeto
send "cd /var/www/deriv-bots\r"
expect "# "

# Fazer backup
send "cp -r client/build client/build.backup.websocket\r"
expect "# "

# Aplicar novo build
send "rm -rf client/build\r"
expect "# "

send "mv /tmp/websocket-build/build client/\r"
expect "# "

send "chown -R www-data:www-data client/build\r"
expect "# "

send "chmod -R 755 client/build\r"
expect "# "

# Reiniciar PM2
puts "🔄 Reiniciando PM2..."
send "pm2 restart all\r"
expect "# "

# Verificar PM2
send "pm2 status\r"
expect "# "

puts "✅ Deploy das melhorias de WebSocket concluído!"
puts "🌐 Teste agora: https://iaeon.site"
puts "🧪 Verifique:"
puts "   - Reconexão após refresh da página"
puts "   - Atualização do saldo ao trocar conta real/virtual"

send "exit\r"
expect eof