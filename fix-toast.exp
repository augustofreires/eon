#!/usr/bin/expect -f

set timeout 60

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "ğŸ”§ Corrigindo toast.success..."

# Primeiro, vamos ver o contexto da linha 226
send "sed -n '220,235p' ./client/src/contexts/AuthContext.tsx\r"
expect "*#*"

puts "ğŸ“ Aplicando correÃ§Ã£o definitiva do toast..."

# Substituir a linha 226 com a correÃ§Ã£o correta
send "sed -i '226c\\        if (manual) { toast.success(`Conta alterada para: \\${account.loginid} (\\${account.currency}) - \\${account.is_virtual ? '\"'\"'Virtual'\"'\"' : '\"'\"'Real'\"'\"'}`); }' ./client/src/contexts/AuthContext.tsx\r"
expect "*#*"

# Verificar se foi aplicado
send "grep -n -A 1 -B 1 'manual.*toast' ./client/src/contexts/AuthContext.tsx\r"
expect "*#*"

puts "ğŸ”§ Aplicando mais correÃ§Ãµes para evitar mÃºltiplas notificaÃ§Ãµes..."

# Verificar e corrigir tambÃ©m possÃ­veis outras fontes de notificaÃ§Ãµes
# Verificar se hÃ¡ outras chamadas de toast no OperationsPage
send "grep -n 'toast.*Conta.*conectada' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ—ï¸ Fazendo build..."
send "cd client && npm run build\r"
expect {
    "*build folder is ready*" {
        puts "âœ… Build OK"
    }
    "*compiled successfully*" {
        puts "âœ… Build OK"
    }
    timeout {
        puts "â° Build timeout"
    }
}
expect "*#*"

puts "ğŸ”„ Reiniciando PM2..."
send "cd /root/eon && pm2 restart all\r"
expect "*#*"

puts "ğŸ‰ CORREÃ‡ÃƒO APLICADA!"
puts "ğŸ§ª Teste agora: https://iaeon.site/operations"

send "exit\r"
expect eof