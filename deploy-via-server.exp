#!/usr/bin/expect -f

set timeout 60
set password "62uDLW4RJ9ae28EPVfp5yzT##"

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "*password:" {
        send "$password\r"
        exp_continue
    }
    "*# " {
        puts "\nğŸš€ FAZENDO DEPLOY DO FRONTEND CORRIGIDO..."

        # Navegar para o projeto
        send "cd /root/eon\r"
        expect "*# "

        # Fazer build do frontend no servidor
        puts "\nğŸ“¦ Fazendo build do frontend no servidor..."
        send "cd client\r"
        expect "*# "

        send "npm run build\r"
        expect {
            "webpack compiled" {
                puts "\nâœ… Build concluÃ­do!"
            }
            "Compiled successfully" {
                puts "\nâœ… Build concluÃ­do!"
            }
            timeout {
                puts "\nâ³ Build ainda em andamento..."
            }
        }

        # Aguardar mais um pouco para garantir que terminou
        sleep 5
        send "\r"
        expect "*# "

        # Copiar arquivos para o diretÃ³rio web
        puts "\nğŸ“‚ Copiando arquivos para /var/www/html..."
        send "cp -r build/* /var/www/html/\r"
        expect "*# "

        # Verificar se os arquivos foram copiados
        send "ls -la /var/www/html/static/js/main*.js\r"
        expect "*# "

        # Reiniciar nginx
        puts "\nğŸ”„ Reiniciando nginx..."
        send "systemctl reload nginx\r"
        expect "*# "

        puts "\nâœ… DEPLOY CONCLUÃDO!"
        puts "ğŸŒ Teste: https://iaeon.site/operations"
        puts "ğŸ¤– Agora os bots devem aparecer corretamente!"

        send "exit\r"
    }
}

expect eof