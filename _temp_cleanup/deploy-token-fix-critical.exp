#!/usr/bin/expect -f

# Deploy da correÃ§Ã£o crÃ­tica do token para VPS
set timeout 300

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
    }
}

expect "# "
send_user "ðŸš€ DEPLOY: CORREÃ‡ÃƒO CRÃTICA DO TOKEN\n"
send_user "ðŸŽ¯ CORRIGINDO: Endpoint /get-token para retornar token especÃ­fico da conta\n"

send "cd /root/eon\r"
expect "# "

# Fazer backup do servidor
send "cp server/routes/auth.js server/routes/auth.js.backup.token-fix.\$(date +%Y%m%d_%H%M%S)\r"
expect "# "

send_user "ðŸ“¤ Fazendo upload da correÃ§Ã£o...\n"

# Upload do arquivo corrigido
send "exit\r"
expect eof

# Fazer upload do arquivo usando scp
spawn scp -o PreferredAuthentications=password -o PubkeyAuthentication=no "/Users/augustofreires/Desktop/Bots deriv/server/routes/auth.js" root@31.97.28.231:/root/eon/server/routes/auth.js

expect {
    "password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
    }
}

expect eof

# Reconectar para reiniciar o servidor
spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
    }
}

expect "# "
send "cd /root/eon\r"
expect "# "

send_user "ðŸ”„ Reiniciando servidor com correÃ§Ã£o...\n"
send "pm2 restart server\r"
expect "# "

send_user "âœ… CORREÃ‡ÃƒO CRÃTICA DEPLOYADA!\n"
send_user "\nðŸ”§ CORREÃ‡ÃƒO APLICADA:\n"
send_user "   âœ… Endpoint /get-token agora retorna token especÃ­fico da conta ativa\n"
send_user "   âœ… NÃ£o mais usa token padrÃ£o (que causava account mismatch)\n"
send_user "   âœ… Busca no deriv_accounts_tokens pelo loginid da conta ativa\n"
send_user "   âœ… Logs crÃ­ticos adicionados para debugging\n"
send_user "\nðŸ§ª TESTE AGORA:\n"
send_user "   1. Abra https://iaeon.site\n"
send_user "   2. Abra DevTools > Console\n"
send_user "   3. Troque de conta\n"
send_user "   4. OBSERVE: 'CRITICAL: Found specific token for account'\n"
send_user "   5. VERIFIQUE: Balance deve atualizar corretamente!\n"

interact