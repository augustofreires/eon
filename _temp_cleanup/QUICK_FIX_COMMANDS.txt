#!/bin/bash
# COMANDOS PARA EXECUTAR NA VPS - COPIE E COLE LINHA POR LINHA

cd /root/eon

# Verificar se a fun√ß√£o j√° existe
grep -n "subscribeToBalanceUpdates" client/src/services/DerivWebSocketService.ts

# Se n√£o retornou nada, adicionar a fun√ß√£o:
cat >> client/src/services/DerivWebSocketService.ts << 'EOF'

  /**
   * PADR√ÉO OFICIAL DERIV: Subscribe to balance updates after authorization
   */
  private subscribeToBalanceUpdates(): void {
    console.log('üí∞ Subscribing to balance updates (official Deriv pattern)...');

    const request = {
      balance: 1,
      subscribe: 1,
      req_id: this.generateRequestId('balance_sub')
    };

    this.subscribers.set('balance_updates', {
      onConnection: (data: any) => {
        if (data.balance) {
          console.log('üí∞ DERIV PATTERN: Balance update received:', data.balance);
          this.notifySubscribers('onBalance', {
            balance: data.balance.balance,
            currency: data.balance.currency,
            loginid: data.balance.loginid || this.currentAccount
          });
        }
      }
    });

    this.send(request);
    console.log('‚úÖ Balance subscription request sent');
  }
EOF

# Adicionar a chamada da fun√ß√£o ap√≥s autoriza√ß√£o
sed -i '/this.currentAccount = data.authorize.loginid;/a\            this.subscribeToBalanceUpdates();' client/src/services/DerivWebSocketService.ts

# Rebuild obrigat√≥rio
npm run build

# Reload nginx
systemctl reload nginx

echo "‚úÖ CORRE√á√ÉO APLICADA! Teste agora em https://iaeon.site"