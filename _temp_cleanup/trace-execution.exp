#!/usr/bin/expect -f

set timeout 30

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "ğŸ” ADICIONANDO ALERTS PARA RASTREAR ONDE PARA..."

# Verificar o useEffect que deveria executar o cÃ³digo
send "grep -n -A 20 'useEffect.*\\[\\]' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸš¨ ADICIONANDO ALERT NO INÃCIO DO useEffect..."

# Encontrar o useEffect e adicionar alert no inÃ­cio
send "sed -i '/useEffect(() => {/a\\    alert(\"ğŸŸ¢ useEffect INICIADO!\");' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸš¨ ADICIONANDO ALERT ANTES DO processOAuthCallback..."

# Adicionar alert antes de processOAuthCallback
send "sed -i '/const processOAuthCallback/i\\    alert(\"ğŸŸ¡ Chegou atÃ© processOAuthCallback!\");' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸš¨ ADICIONANDO ALERT DEPOIS DO processOAuthCallback..."

# Adicionar alert depois do try/catch do OAuth
send "sed -i '/console.log.*Carregando configuraÃ§Ãµes iniciais/i\\    alert(\"ğŸŸ  Passou do OAuth, vai carregar configuraÃ§Ãµes!\");' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ—ï¸ BUILD COM RASTREAMENTO COMPLETO..."
send "cd client && npm run build\r"
expect {
    "*build folder is ready*" {
        puts "âœ… Build OK"
    }
    "*compiled successfully*" {
        puts "âœ… Build OK"
    }
    timeout {
        puts "â° Building..."
    }
}
expect "*#*"

send "cd /root/eon && pm2 restart all\r"
expect "*#*"

puts ""
puts "ğŸ” RASTREAMENTO ATIVADO!"
puts "========================"
puts ""
puts "ğŸ§ª TESTE E VEJA QUAL ALERT APARECE:"
puts "   ğŸŸ¢ 'useEffect INICIADO!' â†’ useEffect executa"
puts "   ğŸŸ¡ 'Chegou atÃ© processOAuthCallback!' â†’ Chegou atÃ© OAuth"
puts "   ğŸŸ  'Passou do OAuth, vai carregar configuraÃ§Ãµes!' â†’ OAuth OK"
puts "   ğŸ”¥ 'PRESTES A CHAMAR loadAvailableBots!' â†’ Vai chamar funÃ§Ã£o"
puts ""
puts "â“ Onde parar = onde estÃ¡ o problema!"

interact