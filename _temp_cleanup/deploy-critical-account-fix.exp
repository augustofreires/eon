#!/usr/bin/expect -f

# Deploy crÃ­tico para correÃ§Ã£o do bug de troca de contas
# PROBLEMA: UsuÃ¡rio solicita CR7346451 mas backend retorna CR6656944

set timeout 300
set server_ip "31.97.28.231"
set username "root"
set password "62uDLW4RJ9ae28EPVfp5yzT##"

log_user 1

# Conectar ao servidor
spawn ssh $username@$server_ip
expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " { }
    timeout {
        puts "âŒ TIMEOUT: NÃ£o foi possÃ­vel conectar ao servidor"
        exit 1
    }
}

puts "ğŸš€ DEPLOY CRÃTICO: CorreÃ§Ã£o do bug de troca de contas"
puts "ğŸ“‹ PROBLEMA: Sistema retorna conta errada quando usuÃ¡rio solicita troca"
puts "ğŸ”§ SOLUÃ‡ÃƒO: ValidaÃ§Ã£o de conta solicitada vs conta retornada"

# 1. Fazer backup do arquivo atual
send "cd /root/eonbackend\r"
expect "# "

send "cp server/routes/auth.js server/routes/auth.js.backup.$(date +%Y%m%d_%H%M%S)\r"
expect "# "
puts "âœ… Backup do auth.js criado"

# 2. Fazer upload do arquivo corrigido
send "exit\r"
expect eof

# Upload do arquivo corrigido
puts "ğŸ“¤ Fazendo upload do arquivo corrigido..."
spawn scp "/Users/augustofreires/Desktop/Bots deriv/server/routes/auth.js" $username@$server_ip:/root/eonbackend/server/routes/auth.js
expect {
    "password:" {
        send "$password\r"
    }
}
expect eof

# 3. Reconectar e reiniciar o servidor
spawn ssh $username@$server_ip
expect {
    "password:" {
        send "$password\r"
    }
    "# " { }
}

send "cd /root/eonbackend\r"
expect "# "

# Reiniciar o servidor com PM2
puts "ğŸ”„ Reiniciando servidor backend..."
send "pm2 restart eon-backend\r"
expect "# "

# Aguardar um momento para o servidor subir
send "sleep 5\r"
expect "# "

# 4. Verificar se o servidor estÃ¡ rodando
puts "ğŸ” Verificando status do servidor..."
send "pm2 status\r"
expect "# "

# 5. Verificar logs para confirmar que a correÃ§Ã£o estÃ¡ ativa
puts "ğŸ“‹ Verificando logs do servidor..."
send "pm2 logs eon-backend --lines 20\r"
expect {
    "# " { }
    timeout {
        puts "âš ï¸ Logs podem estar ainda carregando..."
    }
}

# 6. Teste simples da API
puts "ğŸ§ª Testando endpoint de informaÃ§Ãµes da conta..."
send "curl -s https://iaeon.site/api/auth/test-endpoint | head -5\r"
expect "# "

puts ""
puts "ğŸ¯ DEPLOY CONCLUÃDO - CORREÃ‡ÃƒO CRÃTICA APLICADA"
puts ""
puts "ğŸ“ RESUMO DA CORREÃ‡ÃƒO:"
puts "   âœ… Adicionada validaÃ§Ã£o de conta solicitada vs conta retornada"
puts "   âœ… Sistema agora rejeita se Deriv retornar conta diferente da solicitada"
puts "   âœ… Logs detalhados para debug de problemas de troca de conta"
puts ""
puts "ğŸ” PRÃ“XIMOS PASSOS:"
puts "   1. Testar troca de contas no frontend"
puts "   2. Verificar se conta CR7346451 Ã© retornada corretamente"
puts "   3. Monitorar logs para confirmar funcionamento"
puts ""
puts "ğŸ“ CONTATO: Se problemas persistirem, verificar logs com:"
puts "   pm2 logs eon-backend --lines 50"

send "exit\r"
expect eof

puts "âœ… Deploy crÃ­tico concluÃ­do!"