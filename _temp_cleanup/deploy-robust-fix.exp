#!/usr/bin/expect -f

set timeout 300
set password "62uDLW4RJ9ae28EPVfp5yzT##"

# Upload backend with verification
puts "ğŸ“¦ Uploading robust backend fix..."
spawn scp server/routes/auth.js root@31.97.28.231:/root/eon/server/routes/

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {
        puts "âœ… Backend uploaded with verification"
    }
}

# Connect and restart
spawn ssh root@31.97.28.231

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        puts "âœ… Connected to apply robust fix"
    }
}

send "cd /root/eon\r"
expect "# "

puts "ğŸ”„ Restarting server with verification system..."
send "pm2 restart iaeon-server\r"
expect "# "

send "pm2 status\r"
expect "# "

puts "\nâœ… CorreÃ§Ã£o robusta aplicada!"
puts "ğŸŒ Teste agora: https://iaeon.site"
puts ""
puts "ğŸ›¡ï¸ Sistema de verificaÃ§Ã£o implementado:"
puts "   âœ“ Verifica se UPDATE realmente funcionou"
puts "   âœ“ Tenta novamente se falhar"
puts "   âœ“ Logs detalhados para debug"
puts "   âœ“ Compara expected vs actual"
puts ""
puts "ğŸ” Agora nos logs vocÃª verÃ¡:"
puts "   - Se o banco foi realmente atualizado"
puts "   - ComparaÃ§Ã£o entre esperado e atual"
puts "   - Segunda tentativa se necessÃ¡rio"

send "exit\r"
expect eof