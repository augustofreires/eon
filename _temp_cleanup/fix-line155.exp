#!/usr/bin/expect -f

set timeout 120

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "ğŸ¯ ENCONTREI O PROBLEMA! Linha 155 do OperationsPage.tsx"
puts "ğŸ”§ Corrigindo a linha que gera as mÃºltiplas notificaÃ§Ãµes..."

# Mostrar o contexto da linha 155
send "sed -n '150,160p' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

# Comentar a linha 155 que gera as notificaÃ§Ãµes
send "sed -i '155s/.*/        \\/\\/ CORREÃ‡ÃƒO: NotificaÃ§Ã£o removida para evitar spam - OAuth jÃ¡ mostra notificaÃ§Ã£o/' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

# Verificar a correÃ§Ã£o
puts "ğŸ“‹ Verificando correÃ§Ã£o aplicada:"
send "sed -n '150,160p' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

puts "ğŸ—ï¸ Fazendo build final..."
send "cd client\r"
expect "*#*"

send "npm run build\r"
expect {
    "*build folder is ready*" {
        puts "âœ… Build final completo!"
    }
    "*compiled successfully*" {
        puts "âœ… Build final completo!"
    }
    timeout {
        puts "â° Build em andamento..."
    }
}
expect "*#*"

puts "ğŸ”„ Reiniciando PM2 - correÃ§Ã£o final..."
send "cd /root/eon && pm2 restart all\r"
expect "*#*"

send "pm2 status\r"
expect "*#*"

puts ""
puts "ğŸ‰ CORREÃ‡ÃƒO DEFINITIVA APLICADA!"
puts "=================================="
puts "âœ… AuthContext: toast sÃ³ aparece quando manual"
puts "âœ… OperationsPage linha 155: notificaÃ§Ã£o removida"
puts "âœ… Build e restart concluÃ­dos"
puts ""
puts "ğŸ§ª TESTE AGORA:"
puts "   https://iaeon.site/operations"
puts "   cliente@iaeon.com / 123456"
puts ""
puts "ğŸ¯ Agora deve aparecer APENAS 1 notificaÃ§Ã£o!"

send "exit\r"
expect eof