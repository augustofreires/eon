#!/usr/bin/expect -f

set timeout 60

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
   "password:" {
       send "62uDLW4RJ9ae28EPVfp5yzT##\r"
   }
}

expect "# "
send_user "ğŸ”§ REMOVENDO RATE LIMITING PARA FAZER SERVIDOR FUNCIONAR\n\n"

send "cd /root/eon\r"
expect "# "

send_user "1. ğŸ“‹ Fazendo backup do index.js:\n"
send "cp server/index.js server/index.js.backup.$(date +%Y%m%d_%H%M%S)\r"
expect "# "

send_user "2. ğŸ”§ Comentando rate limiting:\n"
send "sed -i '/const limiter = rateLimit/,/app.use.*limiter/ s/^/\\/\\/ /' server/index.js\r"
expect "# "

send_user "3. ğŸ“‹ Verificando se foi comentado:\n"
send "grep -A8 -B2 'limiter.*rateLimit\\|app.use.*limiter' server/index.js\r"
expect "# "

send_user "4. ğŸ”„ Reiniciando servidor:\n"
send "pm2 restart eon-pro-server\r"
expect "# "

send_user "5. â° Aguardando inicializaÃ§Ã£o:\n"
send "sleep 8\r"
expect "# "

send_user "6. ğŸ§ª TESTE FINAL:\n"
send "curl -s 'http://localhost:5001/api/health' && echo ' âœ… SERVIDOR FINALMENTE FUNCIONANDO!' || echo ' âŒ CONTINUA QUEBRADO'\r"
expect "# "

send_user "7. ğŸ”— Testando atravÃ©s do nginx (porta 80):\n"
send "curl -s 'http://localhost/api/health' && echo ' âœ… NGINX OK!' || echo ' âŒ NGINX PROBLEM'\r"
expect "# "

send_user "\nğŸ¯ SE O SERVIDOR ESTIVER FUNCIONANDO, TESTE A TROCA DE CONTA AGORA!\n"

interact
