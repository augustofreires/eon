#!/usr/bin/expect -f

set timeout 60

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "ğŸ” INVESTIGAÃ‡ÃƒO PROFUNDA - Procurando TODAS as fontes de notificaÃ§Ãµes..."

# 1. Procurar TODAS as ocorrÃªncias de toast.success no projeto
send "grep -rn 'toast.success.*[Cc]onta.*[Cc]onectada' ./client/src/ || echo 'Nenhuma encontrada'\r"
expect "*#*"

# 2. Procurar no backend tambÃ©m
send "grep -rn 'notificaÃ§Ã£o\\|notification\\|toast' ./server/ || echo 'Nenhuma encontrada no server'\r"
expect "*#*"

# 3. Verificar se hÃ¡ mÃºltiplas chamadas para o endpoint OAuth
send "grep -rn '/api/auth/deriv' ./client/src/ | head -10\r"
expect "*#*"

# 4. Verificar se useEffect estÃ¡ sendo chamado mÃºltiplas vezes
send "grep -rn 'useEffect.*\\[\\]' ./client/src/pages/OperationsPage.tsx\r"
expect "*#*"

# 5. Procurar por outros padrÃµes que possam causar loops
send "grep -rn 'processOAuthCallback\\|oauth.*callback' ./client/src/\r"
expect "*#*"

puts "ğŸ“‹ Verificando se build foi aplicado corretamente..."

# 6. Verificar timestamp do Ãºltimo build
send "ls -la ./client/build/static/js/ | head -5\r"
expect "*#*"

# 7. ForÃ§ar limpeza do cache do build
puts "ğŸ§¹ Limpando cache e rebuild..."
send "cd client\r"
expect "*#*"

send "rm -rf build/ node_modules/.cache/\r"
expect "*#*"

send "npm run build\r"
expect {
    "*build folder is ready*" {
        puts "âœ… Rebuild completo"
    }
    "*compiled successfully*" {
        puts "âœ… Rebuild completo"
    }
    timeout {
        puts "â° Rebuild em andamento..."
    }
}
expect "*#*"

send "cd /root/eon && pm2 restart all\r"
expect "*#*"

puts ""
puts "ğŸ” INVESTIGAÃ‡ÃƒO CONCLUÃDA"
puts "ğŸ§ª Teste novamente: https://iaeon.site/operations"
puts "ğŸ’¡ Se ainda nÃ£o funcionar, pode ser problema de cache do navegador"

send "exit\r"
expect eof