#!/usr/bin/expect -f

set timeout 30
set password "62uDLW4RJ9ae28EPVfp5yzT##"

spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@31.97.28.231

expect {
    "*password:" {
        send "$password\r"
        exp_continue
    }
    "*passphrase*" {
        send "$password\r"
        exp_continue
    }
    "*# " {
        puts "=== TESTANDO SERVIDOR ==="

        # Verificar status PM2
        send "pm2 status\r"
        expect "*# "

        # Testar endpoint simples
        send "curl -v https://iaeon.site/api/auth/status 2>&1 | head -20\r"
        expect "*# "

        # Testar endpoint de bots sem auth (deve retornar 401)
        send "curl -s -w \"\\nHTTP_CODE: %{http_code}\\n\" https://iaeon.site/api/bots\r"
        expect "*# "

        # Verificar logs mais recentes
        send "pm2 logs iaeon-server --lines 5 --raw\r"
        expect "*# "

        send "exit\r"
    }
    timeout {
        puts "Timeout na conex√£o SSH"
        exit 1
    }
}

expect eof