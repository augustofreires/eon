#!/usr/bin/expect -f

set timeout 60
set password "7eL3Kp9#nX2qF8sR"

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "*password:" {
        send "$password\r"
        exp_continue
    }
    "*# " {
        puts "\n🚀 APLICANDO CORREÇÕES POSTGRESQL..."

        send "cd /root/eon\r"
        expect "*# "

        # Criar script de correção SQL direto no servidor
        puts "\n📝 CRIANDO SCRIPT DE CORREÇÃO SQL..."
        send "cat > fix_postgresql_schema.sql << 'EOF'\r"
        expect "*# "

        send "-- Adicionar colunas faltantes à tabela deriv_config\r"
        send "ALTER TABLE deriv_config ADD COLUMN IF NOT EXISTS affiliate_link TEXT;\r"
        send "\r"
        send "-- Adicionar colunas faltantes à tabela bots\r"
        send "ALTER TABLE bots ADD COLUMN IF NOT EXISTS image_url TEXT;\r"
        send "\r"
        send "-- Adicionar colunas faltantes à tabela users\r"
        send "ALTER TABLE users ADD COLUMN IF NOT EXISTS profile_picture TEXT;\r"
        send "\r"
        send "-- Inserir dados padrão se não existirem\r"
        send "INSERT INTO deriv_config (user_id, app_id, api_token, is_active, affiliate_link) \r"
        send "SELECT 1, '82349', 'default_token', true, 'https://deriv.com/?a=82349' \r"
        send "WHERE NOT EXISTS (SELECT 1 FROM deriv_config WHERE user_id = 1);\r"
        send "EOF\r"
        expect "*# "

        # Aplicar correções SQL
        puts "\n🔧 APLICANDO CORREÇÕES NO BANCO DE DADOS..."
        send "sudo -u postgres psql -d eon_platform -f fix_postgresql_schema.sql\r"
        expect "*# "

        # Verificar se as colunas foram adicionadas
        puts "\n🔍 VERIFICANDO ESTRUTURA DO BANCO..."
        send "sudo -u postgres psql -d eon_platform -c '\\d+ deriv_config'\r"
        expect "*# "

        send "sudo -u postgres psql -d eon_platform -c '\\d+ bots'\r"
        expect "*# "

        # Verificar dados existentes
        puts "\n📊 VERIFICANDO DADOS..."
        send "sudo -u postgres psql -d eon_platform -c 'SELECT COUNT(*) FROM users;'\r"
        expect "*# "

        send "sudo -u postgres psql -d eon_platform -c 'SELECT COUNT(*) FROM bots;'\r"
        expect "*# "

        send "sudo -u postgres psql -d eon_platform -c 'SELECT COUNT(*) FROM deriv_config;'\r"
        expect "*# "

        # Reiniciar servidor
        puts "\n🔄 REINICIANDO SERVIDOR..."
        send "pm2 restart iaeon-server\r"
        expect "*# "

        sleep 3

        # Verificar logs
        puts "\n📋 VERIFICANDO LOGS DO SERVIDOR..."
        send "pm2 logs iaeon-server --lines 10\r"
        expect "*# "

        # Testar endpoints
        puts "\n🧪 TESTANDO ENDPOINTS..."
        send "curl -s -o /dev/null -w '%{http_code}' http://localhost:5000/api/auth/deriv-affiliate-link\r"
        expect "*# "

        send "curl -s http://localhost:5000/api/bots | head -20\r"
        expect "*# "

        puts "\n✅ PROCESSO CONCLUÍDO!"
        send "exit\r"
    }
}

expect eof