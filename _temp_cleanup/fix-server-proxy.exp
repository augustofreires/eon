#!/usr/bin/expect -f

set timeout 60

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
   "password:" {
       send "62uDLW4RJ9ae28EPVfp5yzT##\r"
   }
}

expect "# "
send_user "ğŸ”§ CORRIGINDO CONFIGURAÃ‡ÃƒO DO SERVIDOR...\n\n"

send "cd /root/eon\r"
expect "# "

send_user "1. ğŸ¯ PROBLEMA IDENTIFICADO:\n"
send_user "   âŒ Servidor roda na porta 5000, nÃ£o 3000\n"
send_user "   âŒ Express nÃ£o confia no nginx proxy\n"

send_user "\n2. ğŸ”§ Corrigindo trust proxy no server/index.js:\n"
send "grep -n 'trust proxy' server/index.js || echo 'Trust proxy not found'\r"
expect "# "

send_user "\n3. ğŸ”§ Adicionando trust proxy configuration:\n"
send "sed -i '/const app = express()/a app.set(\"trust proxy\", true);' server/index.js\r"
expect "# "

send_user "\n4. ğŸ“‹ Verificando se foi adicionado:\n"
send "grep -A2 -B2 'trust proxy' server/index.js\r"
expect "# "

send_user "\n5. ğŸ”„ Reiniciando servidor:\n"
send "pm2 restart eon-pro-server\r"
expect "# "

send_user "\n6. â° Aguardando inicializaÃ§Ã£o:\n"
send "sleep 8\r"
expect "# "

send_user "\n7. ğŸ§ª Testando porta correta (5000):\n"
send "curl -s 'http://localhost:5000/api/health' && echo ' âœ… SERVER WORKING!' || echo ' âŒ SERVER STILL BROKEN'\r"
expect "# "

send_user "\n8. ğŸ§ª Testando nginx proxy (porta 3000):\n"
send "curl -s 'http://localhost:3000/api/health' && echo ' âœ… NGINX PROXY WORKING!' || echo ' âŒ NGINX PROXY BROKEN'\r"
expect "# "

send_user "\n9. ğŸ“¡ Iniciando monitoramento para teste de troca:\n"
send "pm2 logs eon-pro-server --lines 0 | grep --line-buffered -E 'get-token|switch-account|CRITICAL|POST' &\r"
expect "# "

send_user "\nğŸ¯ AGORA TESTE A TROCA DE CONTA - O SERVIDOR ESTÃ FUNCIONANDO!\n"
send "sleep 20\r"
expect "# "

send "pkill tail\r"
expect "# "

interact
