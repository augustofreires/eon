#!/usr/bin/expect -f

set timeout 120

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "🔧 Corrigindo linha 226 do AuthContext..."

# Primeiro, comentar a linha atual
send "sed -i '226s/^/\\/\\/ /' ./client/src/contexts/AuthContext.tsx\r"
expect "*#*"

# Adicionar a nova linha com a correção
send "sed -i '226a\\        if (manual) toast.success(`Conta alterada para: \$\{account.loginid\} (\$\{account.currency\})`);' ./client/src/contexts/AuthContext.tsx\r"
expect "*#*"

# Verificar se foi aplicado
send "sed -n '225,230p' ./client/src/contexts/AuthContext.tsx\r"
expect "*#*"

puts "🔧 Verificando outras fontes de notificações..."

# Procurar por outras fontes de toast de conexão
send "grep -rn 'toast.*Conta.*conectada' ./client/src/\r"
expect "*#*"

puts "🏗️ Build..."
send "cd client\r"
expect "*#*"

send "npm run build\r"
expect {
    "*build folder is ready*" {
        puts "✅ Build completo"
    }
    "*compiled successfully*" {
        puts "✅ Build completo"
    }
    timeout {
        puts "⏰ Build timeout"
    }
}
expect "*#*"

puts "🔄 PM2 restart..."
send "cd /root/eon && pm2 restart all\r"
expect "*#*"

puts "🎉 APLICADO! Teste: https://iaeon.site/operations"

send "exit\r"
expect eof