#!/usr/bin/expect -f

set timeout 300
set password "62uDLW4RJ9ae28EPVfp5yzT##"

# Upload do backend corrigido
puts "ğŸ“¦ Fazendo upload da correÃ§Ã£o final do servidor..."
spawn scp server/routes/auth.js root@31.97.28.231:/root/eon/server/routes/

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {
        puts "âœ… Upload da correÃ§Ã£o concluÃ­do"
    }
}

# Conectar e reiniciar
puts "ğŸ”— Conectando para reiniciar servidor..."
spawn ssh root@31.97.28.231

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        puts "âœ… Conectado ao VPS"
    }
}

send "cd /root/eon\r"
expect "# "

# Reiniciar PM2
puts "ğŸ”„ Reiniciando servidor com correÃ§Ã£o de saldo..."
send "pm2 restart iaeon-server\r"
expect "# "

send "pm2 status\r"
expect "# "

puts "\nâœ… CorreÃ§Ã£o final aplicada!"
puts "ğŸŒ Teste agora: https://iaeon.site"
puts ""
puts "ğŸ§ª Agora ao trocar contas:"
puts "   âœ“ O saldo real deve aparecer imediatamente"
puts "   âœ“ NÃ£o haverÃ¡ mais saldo fixo ou zero"
puts "   âœ“ A interface nÃ£o deve mais ficar preta por muito tempo"
puts ""
puts "ğŸ” CorreÃ§Ãµes aplicadas:"
puts "   - Endpoint switch-account busca saldo real via WebSocket"
puts "   - Endpoint account-info tambÃ©m busca saldo real"
puts "   - Fallback melhorado para casos de erro"

send "exit\r"
expect eof