#!/usr/bin/expect -f

set timeout 60

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
   "password:" {
       send "62uDLW4RJ9ae28EPVfp5yzT##\r"
   }
}

expect "# "
send_user "ğŸš¨ DIAGNÃ“STICO FINAL DO SERVIDOR...\n\n"

send "cd /root/eon\r"
expect "# "

send_user "1. ğŸ“‹ Logs de erro completos:\n"
send "pm2 logs eon-pro-server --err --lines 20\r"
expect "# "

send_user "\n2. ğŸ” Verificando se hÃ¡ processo rodando:\n"
send "ps aux | grep node\r"
expect "# "

send_user "\n3. ğŸ§ª Testando porta 5001:\n"
send "curl -s 'http://localhost:5001/api/health' && echo 'PORT 5001 WORKING' || echo 'PORT 5001 BROKEN'\r"
expect "# "

send_user "\n4. ğŸ“Š Verificando portas ativas:\n"
send "netstat -tlnp | grep :500\r"
expect "# "

send_user "\n5. ğŸ”§ Matando tudo e reiniciando limpo:\n"
send "pm2 stop all\r"
expect "# "
send "pkill -f node\r"
expect "# "
send "sleep 3\r"
expect "# "

send_user "\n6. ğŸš€ Iniciando servidor diretamente para ver erro:\n"
send "cd /root/eon/server && timeout 15s node index.js\r"
expect "# " timeout 20

send_user "\n7. âœ… AGORA COM PM2:\n"
send "cd /root/eon\r"
expect "# "
send "pm2 start server/index.js --name eon-pro-server\r"
expect "# "

send_user "\n8. ğŸ§ª TESTE FINAL - Porta correta:\n"
send "sleep 5\r"
expect "# "
send "curl -s 'http://localhost:5001/api/health' && echo 'âœ… FINALMENTE FUNCIONANDO!' || echo 'âŒ Ainda nÃ£o funciona'\r"
expect "# "

interact
