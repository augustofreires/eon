#!/usr/bin/expect -f

set timeout 300
set password "62uDLW4RJ9ae28EPVfp5yzT##"

# Upload backend with verification
puts "📦 Uploading robust backend fix..."
spawn scp server/routes/auth.js root@31.97.28.231:/root/eon/server/routes/

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {
        puts "✅ Backend uploaded with verification"
    }
}

# Connect and restart
spawn ssh root@31.97.28.231

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        puts "✅ Connected to apply robust fix"
    }
}

send "cd /root/eon\r"
expect "# "

puts "🔄 Restarting server with verification system..."
send "pm2 restart iaeon-server\r"
expect "# "

send "pm2 status\r"
expect "# "

puts "\n✅ Correção robusta aplicada!"
puts "🌐 Teste agora: https://iaeon.site"
puts ""
puts "🛡️ Sistema de verificação implementado:"
puts "   ✓ Verifica se UPDATE realmente funcionou"
puts "   ✓ Tenta novamente se falhar"
puts "   ✓ Logs detalhados para debug"
puts "   ✓ Compara expected vs actual"
puts ""
puts "🔍 Agora nos logs você verá:"
puts "   - Se o banco foi realmente atualizado"
puts "   - Comparação entre esperado e atual"
puts "   - Segunda tentativa se necessário"

send "exit\r"
expect eof