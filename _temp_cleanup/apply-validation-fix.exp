#!/usr/bin/expect -f

# Aplicar valida√ß√£o de conta diretamente no servidor
set timeout 120

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
    }
}

expect "# "
send_user "‚úÖ Conectado - Aplicando valida√ß√£o cr√≠tica\n"

send "cd /root/eon\r"
expect "# "

# Aplicar a corre√ß√£o ap√≥s linha 1988 onde acontece a autoriza√ß√£o
send_user "üîß Inserindo valida√ß√£o de conta ap√≥s linha 1988...\n"

# Inserir valida√ß√£o ap√≥s a linha que verifica 'response.authorize'
send "sed -i '1995a\\n              // CRITICAL: Validate requested account matches authorized account\\n              const authorizedLoginId = response.authorize.loginid;\\n              const requestedLoginId = targetAccount.loginid;\\n              \\n              if (authorizedLoginId !== requestedLoginId) {\\n                console.error(`‚ùå CRITICAL: Account mismatch detected!`, {\\n                  requested: requestedLoginId,\\n                  authorized: authorizedLoginId\\n                });\\n                clearTimeout(timeout);\\n                ws.close();\\n                reject(new Error(`Account mismatch: requested \${requestedLoginId} but got \${authorizedLoginId}`));\\n                return;\\n              }\\n              \\n              console.log(`‚úÖ Account validation passed: \${authorizedLoginId}`);\\n' server/routes/auth.js\r"

expect "# "
send_user "‚úÖ Valida√ß√£o aplicada\n"

# Verificar se a corre√ß√£o foi aplicada
send "grep -n -A5 -B2 'Account mismatch' server/routes/auth.js\r"
expect "# "

send_user "üîÑ Reiniciando servidor...\n"
send "pm2 restart eon-pro-server\r"
expect "# "

send "sleep 3\r"
expect "# "

# Verificar status
send "pm2 status\r"
expect "# "

send_user "‚úÖ CORRE√á√ÉO APLICADA E SERVIDOR REINICIADO\n"
send_user "üéØ Sistema agora valida contas na troca\n"

interact