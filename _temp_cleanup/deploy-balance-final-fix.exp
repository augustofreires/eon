#!/usr/bin/expect -f

set timeout 300
set password "62uDLW4RJ9ae28EPVfp5yzT##"

# Upload do backend corrigido
puts "📦 Fazendo upload da correção final do servidor..."
spawn scp server/routes/auth.js root@31.97.28.231:/root/eon/server/routes/

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof {
        puts "✅ Upload da correção concluído"
    }
}

# Conectar e reiniciar
puts "🔗 Conectando para reiniciar servidor..."
spawn ssh root@31.97.28.231

expect {
    "passphrase" {
        send "\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        puts "✅ Conectado ao VPS"
    }
}

send "cd /root/eon\r"
expect "# "

# Reiniciar PM2
puts "🔄 Reiniciando servidor com correção de saldo..."
send "pm2 restart iaeon-server\r"
expect "# "

send "pm2 status\r"
expect "# "

puts "\n✅ Correção final aplicada!"
puts "🌐 Teste agora: https://iaeon.site"
puts ""
puts "🧪 Agora ao trocar contas:"
puts "   ✓ O saldo real deve aparecer imediatamente"
puts "   ✓ Não haverá mais saldo fixo ou zero"
puts "   ✓ A interface não deve mais ficar preta por muito tempo"
puts ""
puts "🔍 Correções aplicadas:"
puts "   - Endpoint switch-account busca saldo real via WebSocket"
puts "   - Endpoint account-info também busca saldo real"
puts "   - Fallback melhorado para casos de erro"

send "exit\r"
expect eof