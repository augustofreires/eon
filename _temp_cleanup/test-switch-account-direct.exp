#!/usr/bin/expect -f

set timeout 60

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
    }
}

expect "# "
send_user "üß™ TESTANDO ENDPOINT SWITCH-ACCOUNT DIRETAMENTE...\n"

send "cd /root/eon\r"
expect "# "

# Primeiro vou pegar um token v√°lido
send_user "üîë Obtendo token v√°lido...\n"
send "curl -s -X GET 'http://localhost:3001/api/auth/deriv/status' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjQsImlhdCI6MTcyNzE5MDI0MywiZXhwIjoxNzI3Mjc2NjQzfQ.VS2xW43s_YsJ6iVxNQXKu6_IEQLnHpXt-7Uo3hRpZno' | head -3\r"
expect "# "

# Agora testar switch-account
send_user "\nüì§ Testando switch-account...\n"
send "curl -v -X POST 'http://localhost:3001/api/auth/deriv/switch-account' \\\r"
expect "# "
send "-H 'Content-Type: application/json' \\\r"
expect "# "
send "-H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjQsImlhdCI6MTcyNzE5MDI0MywiZXhwIjoxNzI3Mjc2NjQzfQ.VS2xW43s_YsJ6iVxNQXKu6_IEQLnHpXt-7Uo3hRpZno' \\\r"
expect "# "
send "-d '{\"is_virtual\": 1, \"loginid\": \"VRTC9858183\"}'\r"
expect "# "

send_user "\nüîç Verificando logs ap√≥s teste...\n"
send "pm2 logs eon-pro-server --lines 10 | tail -20\r"
expect "# "

interact