#!/usr/bin/expect -f

set timeout 30
set password "62uDLW4RJ9ae28EPVfp5yzT##"

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "*password:" {
        send "$password\r"
        exp_continue
    }
    "*# " {
        puts "\nüîß CORRIGINDO DATABASE E TESTANDO TOKEN..."

        # Verificar usu√°rios PostgreSQL dispon√≠veis
        puts "\n1Ô∏è‚É£ USU√ÅRIOS POSTGRESQL DISPON√çVEIS:"
        send "su - postgres -c \"psql -c \\\"\\\\du\\\"\"\r"
        expect "*# "

        # Verificar databases dispon√≠veis
        puts "\n2Ô∏è‚É£ DATABASES DISPON√çVEIS:"
        send "su - postgres -c \"psql -c \\\"\\\\l\\\"\"\r"
        expect "*# "

        # Testar conex√£o com usu√°rio postgres
        puts "\n3Ô∏è‚É£ TESTANDO CONEX√ÉO COM USU√ÅRIO POSTGRES:"
        send "su - postgres -c \"psql eonpro_db -c \\\"SELECT id, email FROM users LIMIT 2;\\\"\"\r"
        expect "*# "

        # Verificar JWT secret no .env
        puts "\n4Ô∏è‚É£ VERIFICANDO JWT SECRET:"
        send "cd /root/eon/server && grep JWT_SECRET .env\r"
        expect "*# "

        puts "\n‚úÖ DIAGN√ìSTICO DB E TOKEN COMPLETO"
        send "exit\r"
    }
}

expect eof