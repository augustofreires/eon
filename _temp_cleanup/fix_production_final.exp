#!/usr/bin/expect -f

set timeout 120

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "*assword*"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"
expect "*#*"

send "cd /root/eon\r"
expect "*#*"

puts "ğŸ›‘ Parando servidor..."
send "pm2 stop iaeon-server\r"
expect "*#*"

puts "ğŸ§¹ Limpando cache completo..."
send "rm -rf client/build client/node_modules/.cache client/.cache\r"
expect "*#*"

puts "ğŸ“¦ Reinstalando dependÃªncias..."
send "cd client\r"
expect "*#*"

send "npm cache clean --force\r"
expect "*#*"

send "npm install\r"
expect {
    "*added*" {
        puts "âœ… DependÃªncias instaladas"
    }
    "*up to date*" {
        puts "âœ… DependÃªncias OK"
    }
    timeout {
        puts "â° Instalando..."
    }
}
expect "*#*"

puts "ğŸ—ï¸ Force rebuild completo..."
send "npm run build\r"
expect {
    "*build folder is ready*" {
        puts "âœ… Build concluÃ­do!"
    }
    "*compiled successfully*" {
        puts "âœ… Build concluÃ­do!"
    }
    timeout {
        puts "â° Building..."
    }
}
expect "*#*"

puts "ğŸ”„ Reiniciando servidor..."
send "cd /root/eon\r"
expect "*#*"

send "pm2 start iaeon-server\r"
expect "*#*"

send "pm2 status\r"
expect "*#*"

puts ""
puts "ğŸ‰ REBUILD COMPLETO FINALIZADO!"
puts "================================="
puts ""
puts "ğŸ§ª TESTE AGORA:"
puts "   https://iaeon.site/operations"
puts "   Login: cliente@iaeon.com / 123456"
puts ""
puts "âœ… DEVE MOSTRAR: 3 bots disponÃ­veis"
puts "   - Bot Martingale"
puts "   - Bot Max Take"
puts "   - cc"

send "exit\r"
expect eof