#!/usr/bin/expect -f

# Deploy rÃ¡pido para correÃ§Ã£o crÃ­tica
set timeout 60
set server_ip "45.56.124.136"
set username "augustofreires"
set password "230106Af!"

log_user 1

puts "ğŸš€ DEPLOY RÃPIDO: CorreÃ§Ã£o crÃ­tica do bug de troca de contas"

# Upload direto do arquivo
spawn scp "/Users/augustofreires/Desktop/Bots deriv/server/routes/auth.js" $username@$server_ip:/root/eonbackend/server/routes/auth.js
expect {
    "password:" {
        send "$password\r"
    }
    "100%" {
        puts "âœ… Arquivo enviado com sucesso"
    }
    timeout {
        puts "âŒ Timeout no upload"
        exit 1
    }
}
expect eof

# Conectar e reiniciar
spawn ssh $username@$server_ip
expect {
    "password:" {
        send "$password\r"
    }
    "$ " {
        puts "âœ… Conectado ao servidor"
    }
    timeout {
        puts "âŒ Timeout na conexÃ£o SSH"
        exit 1
    }
}

# Reiniciar backend
send "cd /root/eonbackend && pm2 restart eon-backend\r"
expect "$ "
puts "âœ… Backend reiniciado"

# Verificar status
send "pm2 status | grep eon-backend\r"
expect "$ "

send "exit\r"
expect eof

puts ""
puts "ğŸ¯ DEPLOY CONCLUÃDO!"
puts "ğŸ“ CorreÃ§Ã£o aplicada: ValidaÃ§Ã£o de conta solicitada vs retornada"
puts "ğŸ” PrÃ³ximo: Testar troca de contas no sistema"