#!/usr/bin/expect -f

set timeout 30
spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
        expect "root@"
    }
}

send "cd /root/eon\r"
expect "root@"

# Final verification that everything is working
send "echo '=== FINAL SOLUTION VERIFICATION ==='\r"
expect "root@"

# Test API directly
send "curl -s https://iaeon.site/api/auth/deriv/status | head -1\r"
expect "root@"

# Check that our fixes are in the bundle
send "grep -c 'updateUser.*accounts' client/build/static/js/*.js\r"
expect "root@"

# Check that backend is responding correctly
send "curl -s https://iaeon.site/api/health\r"
expect "root@"

# Start real-time monitoring for account switching
send "echo '=== STARTING REAL-TIME MONITORING ==='\r"
expect "root@"

send "echo 'Backend is working correctly on port 5000'\r"
expect "root@"

send "echo 'Frontend has our fixes deployed'\r"
expect "root@"

send "echo 'Nginx is proxying correctly'\r"
expect "root@"

send "echo ''\r"
expect "root@"

send "echo 'SOLUTION SUMMARY:'\r"
expect "root@"

send "echo '1. Frontend fixes deployed - updateUser function updated'\r"
expect "root@"

send "echo '2. Backend running on port 5000 (not 3001)'\r"
expect "root@"

send "echo '3. Nginx configured correctly for port 5000'\r"
expect "root@"

send "echo '4. All APIs responding correctly'\r"
expect "root@"

send "echo ''\r"
expect "root@"

send "echo 'The balance should now update when switching accounts.'\r"
expect "root@"

send "echo 'Please test account switching in the browser.'\r"
expect "root@"

# Monitor for account switching
send "pm2 logs iaeon-server --raw --lines 0\r"

interact