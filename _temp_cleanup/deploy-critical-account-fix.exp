#!/usr/bin/expect -f

# Deploy crítico para correção do bug de troca de contas
# PROBLEMA: Usuário solicita CR7346451 mas backend retorna CR6656944

set timeout 300
set server_ip "31.97.28.231"
set username "root"
set password "62uDLW4RJ9ae28EPVfp5yzT##"

log_user 1

# Conectar ao servidor
spawn ssh $username@$server_ip
expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " { }
    timeout {
        puts "❌ TIMEOUT: Não foi possível conectar ao servidor"
        exit 1
    }
}

puts "🚀 DEPLOY CRÍTICO: Correção do bug de troca de contas"
puts "📋 PROBLEMA: Sistema retorna conta errada quando usuário solicita troca"
puts "🔧 SOLUÇÃO: Validação de conta solicitada vs conta retornada"

# 1. Fazer backup do arquivo atual
send "cd /root/eonbackend\r"
expect "# "

send "cp server/routes/auth.js server/routes/auth.js.backup.$(date +%Y%m%d_%H%M%S)\r"
expect "# "
puts "✅ Backup do auth.js criado"

# 2. Fazer upload do arquivo corrigido
send "exit\r"
expect eof

# Upload do arquivo corrigido
puts "📤 Fazendo upload do arquivo corrigido..."
spawn scp "/Users/augustofreires/Desktop/Bots deriv/server/routes/auth.js" $username@$server_ip:/root/eonbackend/server/routes/auth.js
expect {
    "password:" {
        send "$password\r"
    }
}
expect eof

# 3. Reconectar e reiniciar o servidor
spawn ssh $username@$server_ip
expect {
    "password:" {
        send "$password\r"
    }
    "# " { }
}

send "cd /root/eonbackend\r"
expect "# "

# Reiniciar o servidor com PM2
puts "🔄 Reiniciando servidor backend..."
send "pm2 restart eon-backend\r"
expect "# "

# Aguardar um momento para o servidor subir
send "sleep 5\r"
expect "# "

# 4. Verificar se o servidor está rodando
puts "🔍 Verificando status do servidor..."
send "pm2 status\r"
expect "# "

# 5. Verificar logs para confirmar que a correção está ativa
puts "📋 Verificando logs do servidor..."
send "pm2 logs eon-backend --lines 20\r"
expect {
    "# " { }
    timeout {
        puts "⚠️ Logs podem estar ainda carregando..."
    }
}

# 6. Teste simples da API
puts "🧪 Testando endpoint de informações da conta..."
send "curl -s https://iaeon.site/api/auth/test-endpoint | head -5\r"
expect "# "

puts ""
puts "🎯 DEPLOY CONCLUÍDO - CORREÇÃO CRÍTICA APLICADA"
puts ""
puts "📝 RESUMO DA CORREÇÃO:"
puts "   ✅ Adicionada validação de conta solicitada vs conta retornada"
puts "   ✅ Sistema agora rejeita se Deriv retornar conta diferente da solicitada"
puts "   ✅ Logs detalhados para debug de problemas de troca de conta"
puts ""
puts "🔍 PRÓXIMOS PASSOS:"
puts "   1. Testar troca de contas no frontend"
puts "   2. Verificar se conta CR7346451 é retornada corretamente"
puts "   3. Monitorar logs para confirmar funcionamento"
puts ""
puts "📞 CONTATO: Se problemas persistirem, verificar logs com:"
puts "   pm2 logs eon-backend --lines 50"

send "exit\r"
expect eof

puts "✅ Deploy crítico concluído!"