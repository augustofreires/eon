#!/usr/bin/expect -f

set timeout 120

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231
expect "password:"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"

expect "root@"
send "cd /root/eon\r"

expect "root@"
send "echo 'ðŸ”„ Restaurando arquivo do backup...'\r"

expect "root@"
send "cp client/src/services/DerivWebSocketService.bak client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo 'ðŸ”§ Verificando fim do arquivo...'\r"

expect "root@"
send "tail -5 client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo 'ðŸ“ Adicionando funÃ§Ã£o oficial Deriv...'\r"

expect "root@"
send "cat > /tmp/deriv_function.ts << 'FUNCEOF'\r"
send "\r"
send "  /**\r"
send "   * PADRÃƒO OFICIAL DERIV: Subscribe to balance updates after authorization\r"
send "   */\r"
send "  private subscribeToBalanceUpdates(): void {\r"
send "    console.log('ðŸ’° Subscribing to balance updates (official Deriv pattern)...');\r"
send "\r"
send "    const request = {\r"
send "      balance: 1,\r"
send "      subscribe: 1,\r"
send "      req_id: this.generateRequestId('balance_sub')\r"
send "    };\r"
send "\r"
send "    this.subscribers.set('balance_updates', {\r"
send "      onConnection: (data: any) => {\r"
send "        if (data.balance) {\r"
send "          console.log('ðŸ’° DERIV PATTERN: Balance update received:', data.balance);\r"
send "          this.notifySubscribers('onBalance', {\r"
send "            balance: data.balance.balance,\r"
send "            currency: data.balance.currency,\r"
send "            loginid: data.balance.loginid || this.currentAccount\r"
send "          });\r"
send "        }\r"
send "      }\r"
send "    });\r"
send "\r"
send "    this.send(request);\r"
send "    console.log('âœ… Balance subscription request sent');\r"
send "  }\r"
send "FUNCEOF\r"

expect "root@"
send "sed -i '/^}/\$i\\' client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "sed -i '/^}/\$i\\' client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "cat /tmp/deriv_function.ts >> client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo '}' >> client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo 'ðŸ”— Adicionando chamada da funÃ§Ã£o...'\r"

expect "root@"
send "sed -i '/this.currentAccount = data.authorize.loginid;/a\\            this.subscribeToBalanceUpdates();' client/src/services/DerivWebSocketService.ts\r"

expect "root@"
send "echo 'ðŸ”§ Building frontend...'\r"

expect "root@"
send "npm run build\r"
expect "Successfully"

send "systemctl reload nginx\r"

expect "root@"
send "echo 'âœ… CORREÃ‡ÃƒO OFICIAL DERIV APLICADA COM SUCESSO!'\r"

expect "root@"
send "echo 'Teste agora em https://iaeon.site - o saldo deve atualizar automaticamente!'\r"

expect "root@"
send "exit\r"

expect eof
puts "ðŸŽ‰ DEPLOY OFICIAL DERIV COMPLETO!"
