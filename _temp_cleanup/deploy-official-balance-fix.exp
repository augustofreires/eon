#!/usr/bin/expect -f

# Deploy das correÃ§Ãµes de balance seguindo padrÃµes oficiais da Deriv
set timeout 300

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
    }
}

expect "# "
send_user "ğŸš€ DEPLOY: CorreÃ§Ãµes de Balance Update (PADRÃƒO OFICIAL DERIV)\n"
send_user "ğŸ”§ Baseado na anÃ¡lise dos repositÃ³rios oficiais da Deriv\n"

send "cd /root/eon\r"
expect "# "

# Fazer backup
send "cp -r client /root/eon_client_backup_deriv_official_\$(date +%Y%m%d_%H%M%S)\r"
expect "# "

send_user "ğŸ”¨ Fazendo rebuild do frontend com correÃ§Ãµes...\n"
send "cd client && npm run build\r"
expect "# "

# Verificar arquivos gerados
send "ls -la build/static/js/ | head -3\r"
expect "# "

send_user "ğŸ“¤ Aplicando no servidor web...\n"
# Limpar diretÃ³rio web
send "rm -rf /usr/share/nginx/html/*\r"
expect "# "

# Copiar novos arquivos
send "cp -r build/* /usr/share/nginx/html/\r"
expect "# "

# Ajustar permissÃµes
send "chown -R www-data:www-data /usr/share/nginx/html/\r"
expect "# "

send "chmod -R 755 /usr/share/nginx/html/\r"
expect "# "

# Verificar se foi aplicado corretamente
send "ls -la /usr/share/nginx/html/static/js/ | head -3\r"
expect "# "

send_user "âœ… DEPLOY CONCLUÃDO COM SUCESSO!\n"
send_user "\nğŸ¯ CORREÃ‡Ã•ES APLICADAS (PADRÃƒO OFICIAL DERIV):\n"
send_user "   âœ… Re-subscriÃ§Ã£o automÃ¡tica de balance apÃ³s account switch\n"
send_user "   âœ… Cancelamento completo de subscriptions antigas\n"
send_user "   âœ… Refresh forÃ§ado de account data com nova autorizaÃ§Ã£o\n"
send_user "   âœ… AtualizaÃ§Ã£o imediata do estado no frontend\n"
send_user "   âœ… Logs detalhados seguindo padrÃ£o oficial\n"
send_user "\nğŸŒ Site: https://iaeon.site\n"
send_user "ğŸ§ª TESTE: FaÃ§a login e troque entre suas contas\n"
send_user "ğŸ’° O saldo deve ser atualizado automaticamente!\n"

interact