#!/usr/bin/expect -f

# Deploy das correções de balance seguindo padrões oficiais da Deriv
set timeout 300

spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "password:" {
        send "62uDLW4RJ9ae28EPVfp5yzT##\r"
    }
}

expect "# "
send_user "🚀 DEPLOY: Correções de Balance Update (PADRÃO OFICIAL DERIV)\n"
send_user "🔧 Baseado na análise dos repositórios oficiais da Deriv\n"

send "cd /root/eon\r"
expect "# "

# Fazer backup
send "cp -r client /root/eon_client_backup_deriv_official_\$(date +%Y%m%d_%H%M%S)\r"
expect "# "

send_user "🔨 Fazendo rebuild do frontend com correções...\n"
send "cd client && npm run build\r"
expect "# "

# Verificar arquivos gerados
send "ls -la build/static/js/ | head -3\r"
expect "# "

send_user "📤 Aplicando no servidor web...\n"
# Limpar diretório web
send "rm -rf /usr/share/nginx/html/*\r"
expect "# "

# Copiar novos arquivos
send "cp -r build/* /usr/share/nginx/html/\r"
expect "# "

# Ajustar permissões
send "chown -R www-data:www-data /usr/share/nginx/html/\r"
expect "# "

send "chmod -R 755 /usr/share/nginx/html/\r"
expect "# "

# Verificar se foi aplicado corretamente
send "ls -la /usr/share/nginx/html/static/js/ | head -3\r"
expect "# "

send_user "✅ DEPLOY CONCLUÍDO COM SUCESSO!\n"
send_user "\n🎯 CORREÇÕES APLICADAS (PADRÃO OFICIAL DERIV):\n"
send_user "   ✅ Re-subscrição automática de balance após account switch\n"
send_user "   ✅ Cancelamento completo de subscriptions antigas\n"
send_user "   ✅ Refresh forçado de account data com nova autorização\n"
send_user "   ✅ Atualização imediata do estado no frontend\n"
send_user "   ✅ Logs detalhados seguindo padrão oficial\n"
send_user "\n🌐 Site: https://iaeon.site\n"
send_user "🧪 TESTE: Faça login e troque entre suas contas\n"
send_user "💰 O saldo deve ser atualizado automaticamente!\n"

interact