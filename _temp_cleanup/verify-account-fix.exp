#!/usr/bin/expect -f

# Script de verificaÃ§Ã£o da correÃ§Ã£o crÃ­tica
set timeout 30
set server_ip "45.56.124.136"
set username "augustofreires"
set password "230106Af!"

log_user 1

puts "ğŸ” VERIFICAÃ‡ÃƒO: CorreÃ§Ã£o do bug de troca de contas"
puts "=" * 50

# Conectar ao servidor
spawn ssh $username@$server_ip
expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "$ " {
        puts "âœ… Conectado ao servidor"
    }
    timeout {
        puts "âŒ TIMEOUT: NÃ£o foi possÃ­vel conectar"
        exit 1
    }
}

# Verificar se o arquivo foi atualizado
send "cd /root/eonbackend\r"
expect "$ "

puts "\nğŸ“‹ 1. Verificando se correÃ§Ã£o estÃ¡ presente no cÃ³digo..."
send "grep -n 'Account mismatch' server/routes/auth.js\r"
expect {
    "Account mismatch" {
        puts "âœ… CorreÃ§Ã£o encontrada no cÃ³digo"
    }
    "$ " {
        puts "âŒ CorreÃ§Ã£o NÃƒO encontrada - deploy pode ter falhado"
    }
}
expect "$ "

puts "\nğŸ“‹ 2. Verificando status do backend..."
send "pm2 status | grep eon-backend\r"
expect "$ "

puts "\nğŸ“‹ 3. Verificando logs recentes..."
send "pm2 logs eon-backend --lines 5 --nostream\r"
expect "$ "

puts "\nğŸ“‹ 4. Testando endpoint da API..."
send "curl -s -o /dev/null -w '%{http_code}' https://iaeon.site/api/auth/account-info\r"
expect {
    "200" {
        puts "âœ… API respondendo corretamente"
    }
    "$ " {
        puts "âš ï¸  API pode nÃ£o estar respondendo adequadamente"
    }
}
expect "$ "

puts "\nğŸ“‹ 5. Verificando estrutura da validaÃ§Ã£o..."
send "grep -A 5 -B 5 'authorizedLoginId.*requestedLoginId' server/routes/auth.js\r"
expect {
    "authorizedLoginId" {
        puts "âœ… LÃ³gica de validaÃ§Ã£o presente"
    }
    "$ " {
        puts "âŒ LÃ³gica de validaÃ§Ã£o nÃ£o encontrada"
    }
}
expect "$ "

puts "\n" + "=" * 50
puts "ğŸ¯ RESUMO DA VERIFICAÃ‡ÃƒO:"
puts "   âœ… Servidor acessÃ­vel"
puts "   ğŸ“ Verificar output acima para detalhes especÃ­ficos"
puts "   ğŸ”§ Se correÃ§Ã£o nÃ£o estÃ¡ presente, executar deploy manual"
puts ""
puts "ğŸ“ PRÃ“XIMOS PASSOS:"
puts "   1. Se correÃ§Ã£o presente: Testar troca de contas no frontend"
puts "   2. Se correÃ§Ã£o ausente: Executar deploy manual"
puts "   3. Monitorar logs durante testes: pm2 logs eon-backend --follow"
puts ""
puts "ğŸš¨ COMANDO DE EMERGÃŠNCIA (se necessÃ¡rio):"
puts "   pm2 restart eon-backend"

send "exit\r"
expect eof

puts "\nâœ… VerificaÃ§Ã£o concluÃ­da!"