#!/usr/bin/expect -f

set timeout 60
set password "7eL3Kp9#nX2qF8sR"

spawn ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect {
    "*password:" {
        send "$password\r"
        exp_continue
    }
    "*# " {
        puts "\nðŸ” DIAGNOSTICANDO PROBLEMA DO BANCO DE DADOS..."

        # Verificar se PostgreSQL estÃ¡ rodando
        send "systemctl status postgresql\r"
        expect "*# "

        # Verificar bancos existentes
        send "sudo -u postgres psql -l\r"
        expect "*# "

        # Tentar conectar ao banco eon_platform
        send "sudo -u postgres psql -d eon_platform -c '\\dt'\r"
        expect "*# "

        # Se nÃ£o existir, criar o banco
        puts "\nðŸ—ï¸ CRIANDO BANCO SE NECESSÃRIO..."
        send "sudo -u postgres createdb eon_platform 2>/dev/null || echo 'Banco jÃ¡ existe'\r"
        expect "*# "

        # Verificar tabelas novamente
        send "sudo -u postgres psql -d eon_platform -c '\\dt'\r"
        expect "*# "

        # Se nÃ£o houver tabelas, executar setup
        puts "\nðŸš€ EXECUTANDO SETUP DO BANCO..."
        send "cd /root/eon/server\r"
        expect "*# "

        send "node database/setup.js\r"
        expect {
            "*# " {
                puts "\nSetup concluÃ­do"
            }
            timeout {
                puts "\nTimeout no setup"
            }
        }

        # Verificar tabelas apÃ³s setup
        send "sudo -u postgres psql -d eon_platform -c '\\dt'\r"
        expect "*# "

        # Reiniciar servidor
        puts "\nðŸ”„ REINICIANDO SERVIDOR..."
        send "pm2 restart iaeon-server\r"
        expect "*# "

        send "pm2 logs iaeon-server --lines 5\r"
        expect "*# "

        send "exit\r"
    }
}

expect eof