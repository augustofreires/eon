#!/usr/bin/expect -f

set timeout 60
spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no root@31.97.28.231

expect "password:"
send "62uDLW4RJ9ae28EPVfp5yzT##\r"

expect "#"
send "cd /root/eon\r"

expect "#"
send "echo '=== TESTING SITE AVAILABILITY ==='\r"

expect "#"
send "curl -s -o /dev/null -w '%{http_code}' https://iaeon.site/\r"

expect "#"
send "echo '=== CHECKING NEW SERVER LOGS FOR SWITCH ACCOUNTS ==='\r"

expect "#"
send "pm2 logs eon-pro-server --lines 50 | grep -E '(SWITCH|CR6656944|CR7346451|authorized)'\r"

expect "#"
send "echo '=== CHECKING NGINX ACCESS LOGS ==='\r"

expect "#"
send "tail -20 /var/log/nginx/access.log | grep -E '(POST.*switch-account|api/auth)'\r"

expect "#"
send "echo '=== TESTING BACKEND API HEALTH ==='\r"

expect "#"
send "curl -s https://iaeon.site/api/health | jq .\r"

expect "#"
send "echo '=== VERIFYING NEW AUTH.JS DEPLOYED ==='\r"

expect "#"
send "grep -A 5 'accountInfo.*account.*id.*switchResult.loginid' server/routes/auth.js\r"

expect "#"
send "exit\r"
expect eof
